<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro ¬∑ Let‚Äôs Hunt</title>
  <meta name="description" content="√önete a la cacer√≠a urbana en el Gran Buenos Aires. Gratis. Inmersivo. Real." />
  
  <!-- ‚úÖ PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0066ff">
  
  <!-- Firebase SDK (legacy v8.10.1) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <a href="index.html" class="back-link" aria-label="Volver a la p√°gina principal">
    ‚Üê Volver a Inicio
  </a>

  <div class="form-card mission-card" data-type="registro">
    <div class="logo-container centered">
      <img src="logo.webp" alt="Let‚Äôs Hunt">
    </div>

    <h1 class="section-title">Reg√≠strate para comenzar</h1>
    <p class="subtitle">
      Elige tu modo de caza: solo o en equipo.
    </p>

    <form id="registroForm">
      <div class="form-group">
        <label for="nombre">Nombre completo *</label>
        <input 
          type="text" 
          id="nombre" 
          name="nombre"
          required
          autocomplete="name"
          placeholder="Ej: Ana L√≥pez">
      </div>

      <div class="form-group">
        <label for="email">Email *</label>
        <input 
          type="email" 
          id="email" 
          name="email"
          required
          autocomplete="email"
          placeholder="tu@email.com">
      </div>

      <div class="form-group">
        <label for="telefono">Tel√©fono m√≥vil (10 d√≠gitos) *</label>
        <input 
          type="tel" 
          id="telefono" 
          name="telefono"
          required
          autocomplete="tel"
          inputmode="numeric"
          pattern="[0-9]{10}"
          placeholder="1112345678"
          title="Solo 10 d√≠gitos. Ej: 1112345678">
        <p class="privacy-note">Usamos WhatsApp para enviar pistas. Nunca compartimos tu n√∫mero.</p>
      </div>

      <!-- ‚úÖ Modo de juego -->
      <div class="form-group">
        <label>¬øC√≥mo quer√©s jugar? *</label>
        <div class="modo-radio-group">
          <label>
            <input type="radio" name="modo" value="individual" checked required>
            üßç‚Äç‚ôÇÔ∏è Solo (3 misiones)
          </label>
          <label>
            <input type="radio" name="modo" value="equipo" required>
            üë• Equipo (4+ misiones)
          </label>
        </div>
      </div>

      <div class="form-group equipo-info">
        <label for="codigo-equipo">C√≥digo de equipo (opcional)</label>
        <input 
          type="text" 
          id="codigo-equipo" 
          name="codigo_equipo"
          placeholder="Ej: ALPHA7"
          maxlength="7"
          pattern="[A-Z]{4}[0-9]{3}"
          title="4 letras may√∫sculas + 3 n√∫meros. Ej: HUNT245">
        <p class="privacy-note">¬øNo ten√©s c√≥digo? ¬°Pod√©s crear un equipo nuevo despu√©s del registro!</p>
      </div>

      <div class="form-group">
        <label for="zona">Zona de juego *</label>
        <select id="zona" name="zona" required>
          <option value="">Selecciona tu zona...</option>
          <option value="CABA">üìç Ciudad de Buenos Aires (CABA)</option>
          <option value="Avellaneda">üöÇ Avellaneda (incluye Dock Sud, Wilde, Sarand√≠)</option>
          <option value="Lan√∫s">üå≥ Lan√∫s (incluye Remedios de Escalada, Valent√≠n Alsina)</option>
          <option value="Lomas de Zamora">üèòÔ∏è Lomas de Zamora (incluye Banfield, Temperley, Llavallol)</option>
        </select>
      </div>

      <div class="form-group checkbox-group">
        <label>
          <input 
            type="checkbox" 
            id="consent" 
            required>
          Acepto los <a href="politicas.html#terminos" target="_blank" rel="noopener">T√©rminos</a> y la 
          <a href="politicas.html#privacidad" target="_blank" rel="noopener">Pol√≠tica de Privacidad</a> *
        </label>
      </div>

      <!-- L√≠nea divisoria sutil -->
      <div class="form-divider"></div>

      <button type="submit" class="btn-hero" id="submitBtn">
        üîí Registrarme y comenzar la cacer√≠a
      </button>

      <p class="terms">
        Al registrarte, aceptas recibir pistas por WhatsApp. Puedes darte de baja en cualquier momento.
      </p>
    </form>
  </div>

  <script>
  // ========== FIREBASE ==========
  const firebaseConfig = {
    apiKey: "AIzaSyDvMo1LPD_FGk-Ahju8oN7WEn9w0B5bqUE",
    authDomain: "let-s-hunt.firebaseapp.com",
    databaseURL: "https://let-s-hunt-default-rtdb.firebaseio.com",
    projectId: "let-s-hunt",
    storageBucket: "let-s-hunt.firebasestorage.app",
    messagingSenderId: "787017812046",
    appId: "1:787017812046:web:da098b2361df4dda995b1f"
  };
  
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Mostrar/ocultar campo de equipo
  document.querySelectorAll('input[name="modo"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const equipoInfo = document.querySelector('.equipo-info');
      if (radio.value === 'equipo') {
        equipoInfo.classList.add('show');
      } else {
        equipoInfo.classList.remove('show');
      }
    });
  });

  // Generar c√≥digo √∫nico
  function generarCodigoEquipo() {
    const letras = "BCDFGHJKMNPQRSTVWXYZ";
    const nums = "23456789";
    let codigo = "";
    for (let i = 0; i < 4; i++) 
      codigo += letras.charAt(Math.floor(Math.random() * letras.length));
    for (let i = 0; i < 3; i++) 
      codigo += nums.charAt(Math.floor(Math.random() * nums.length));
    return codigo;
  }

  // Manejar env√≠o CON Firebase + localStorage
  document.getElementById('registroForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const nombre = document.getElementById('nombre').value.trim();
    const email = document.getElementById('email').value.trim();
    let telefonoRaw = document.getElementById('telefono').value.trim().replace(/\D/g, '');
    const zona = document.getElementById('zona').value;
    const modo = document.querySelector('input[name="modo"]:checked').value;
    const codigoIngresado = modo === 'equipo' 
      ? document.getElementById('codigo-equipo').value.trim().toUpperCase() 
      : null;

    if (telefonoRaw.length !== 10) {
      alert('‚ö†Ô∏è El n√∫mero debe tener 10 d√≠gitos (sin c√≥digo de pa√≠s). Ej: 1112345678');
      return;
    }

    // Validar que se haya seleccionado una zona
    if (!zona) {
      alert('‚ö†Ô∏è Por favor, selecciona una zona de juego.');
      return;
    }

    // Generar hunterId SECUENCIAL con prefijo LH
    let lastId = parseInt(localStorage.getItem('lastHunterId') || '0');
    let newId = lastId + 1;
    let hunterId = `LH-${String(newId).padStart(4, '0')}`;
    localStorage.setItem('lastHunterId', newId);

    // Gestionar equipo
    let equipo = null;
    if (modo === 'equipo') {
      if (!codigoIngresado) {
        equipo = generarCodigoEquipo();
      } else if (/^[A-Z]{4}[0-9]{3}$/.test(codigoIngresado)) {
        equipo = codigoIngresado;
      } else {
        alert('‚ö†Ô∏è C√≥digo inv√°lido. Debe ser 4 letras + 3 n√∫meros. Ej: HUNT245');
        return;
      }
    }

    // Guardar en localStorage
    const jugador = { id: hunterId, nombre, email, telefono: `+549${telefonoRaw}`, zona, modo, equipo };
    localStorage.setItem(`jugador_${hunterId}`, JSON.stringify(jugador));
    localStorage.setItem('currentHunterId', hunterId);

    // ‚úÖ Guardar en Realtime Database (base de datos real)
    try {
      // Crear usuario an√≥nimo
      const userCredential = await auth.signInAnonymously();
      const user = userCredential.user;

      // Guardar en Realtime Database - jugadores
      await db.ref(`jugadores/${user.uid}`).set({
        hunterId: hunterId,
        nombre: nombre,
        email: email,
        telefono: `+549${telefonoRaw}`,
        zona: zona,
        modo: modo,
        equipo: equipo,
        fecha_registro: Date.now(),
        activo: true
      });

      // ‚úÖ Guardar registro nuevo para administrador (en Realtime Database)
      await db.ref('registros_nuevos').push({
        hunterId: hunterId,
        nombre: nombre,
        email: email,
        telefono: `+549${telefonoRaw}`,
        zona: zona,
        modo: modo,
        equipo: equipo,
        timestamp: Date.now()
      });
    } catch (error) {
      console.error("Error al guardar en Firebase:", error);
      // Continuar igual (no bloquear al usuario)
    }

    // Feedback emocional
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Activando caza‚Ä¶';

    const container = document.querySelector('.form-card');
    const successMsg = document.createElement('div');
    successMsg.className = 'registration-ritual';
    successMsg.innerHTML = `
      üîä <span style="color: #64b5f6;">Cazador identificado.</span><br>
      <span style="font-size: 1.4rem; margin: 0.4rem 0; display: block; color: #fff;">${hunterId.toUpperCase()}</span>
      <span style="font-size: 0.95rem; opacity: 0.85; display: block; margin-top: 0.5rem;">
        Tu zona <strong>${zona}</strong> est√° activa.<br>
        üü¢ <span id="live-count-ritual">24</span> cazadores en el GBA ahora.
      </span>
    `;
    container.insertBefore(successMsg, btn.parentNode);

    // Simular contador
    function updateRitualCounter() {
      const base = 20;
      const fluctuation = Math.floor(Math.random() * 8);
      document.getElementById('live-count-ritual').textContent = base + fluctuation;
    }
    updateRitualCounter();
    setInterval(updateRitualCounter, 3000);

    // Redirigir a app.html (con zona exacta)
    setTimeout(() => {
      window.location.href = `app.html?id=${encodeURIComponent(hunterId)}&zona=${encodeURIComponent(zona)}`;
    }, 1200);
  });
  </script>
</body>
</html>