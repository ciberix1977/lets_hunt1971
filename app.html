<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Let‚Äôs Hunt ¬∑ App</title>
  <meta name="description" content="Tu cacer√≠a urbana en el Gran Buenos Aires" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Librer√≠as externas (sin espacios) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="/manifest.json">
  
  <!-- Estilo para el banner de instalaci√≥n -->
  <style>
    #pwa-install-banner {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.95);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid var(--surface-border);
      text-align: center;
      max-width: 90%;
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="tension-bar" id="tension-bar">‚è≥ <span id="timer">Listo</span></div>
    </div>
    <div class="header-center">
      <img src="logo.webp" alt="Let‚Äôs Hunt" class="app-logo">
    </div>
    <div class="header-right">
      <div class="hunter-id" id="hunterIdDisplay">ID: hunter0000</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- FASE 1: Consigna inicial -->
      <div id="phase1-consigna" class="mission-phase">
        <div class="mission-card"></div>
      </div>

      <!-- FASE 2: Mapa de aproximaci√≥n -->
      <div id="phase2-mapa" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
      </div>

      <!-- FASE 3: Pista final + QR -->
      <div id="phase3-pista" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
      </div>

      <!-- FASE 4: Misi√≥n completada -->
      <div id="phase4-completed" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
      </div>

      <!-- SECCI√ìN PARA EQUIPOS -->
      <div id="teamSection" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
      </div>
    </div>
  </main>

  <!-- Modal de invitaci√≥n (equipo) -->
  <div id="inviteModal" class="modal-overlay">
    <div class="modal-content">
      <h3>üë• Invitar a tu equipo</h3>
      <p>Compart√≠ este c√≥digo para que otros se unan:</p>
      <div id="codigoInvitacion">CARGANDO...</div>
      <div class="modal-actions">
        <button id="copyCodeBtn" class="btn btn-outline">üìã Copiar c√≥digo</button>
        <button id="shareWaBtn" class="btn btn-primary">üí¨ WhatsApp</button>
      </div>
      <button id="closeModalBtn" class="modal-close">Cerrar</button>
    </div>
  </div>

  <!-- Esc√°ner QR -->
  <div id="scannerOverlay" class="modal-overlay">
    <div class="scanner-container">
      <h3>üîç Escanea el C√≥digo QR</h3>
      <video id="scannerVideo" autoplay playsinline></video>
      <canvas id="scannerCanvas" style="display: none;"></canvas>
      
      <div class="scanner-frame">
        <div class="scanner-corner tl"></div>
        <div class="scanner-corner tr"></div>
        <div class="scanner-corner bl"></div>
        <div class="scanner-corner br"></div>
      </div>

      <div class="scanner-actions">
        <button id="closeScannerBtn" class="btn btn-outline">‚ùå Cancelar</button>
        <button id="manualInputBtn" class="btn btn-primary">‚å®Ô∏è Ingresar manualmente</button>
      </div>
    </div>
  </div>

  <!-- NAVEGACI√ìN M√ìVIL -->
  <nav class="mobile-nav">
    <a href="progreso.html#radar"><i>üì°</i>Se√±al en vivo</a>
    <a href="#misiones"><i>üéØ</i>Misiones</a>
    <a href="#scan" id="nav-scan"><i>üîç</i>Escanear</a>
    <a href="progreso.html"><i>üìä</i>Progreso</a>
  </nav>

  <!-- CONTROLES GLOBALES -->
  <button id="narration-toggle" title="Activar/Desactivar narraci√≥n">üîä</button>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Contenedor del banner de instalaci√≥n -->
  <div id="pwa-install-banner"></div>

  <!-- L√ìGICA PRINCIPAL -->
  <script>
    // ========== CONFIGURACI√ìN POR ZONA ==========
    const ZONA_CONFIG = {
      'CABA': {
        misionId: 'M1',
        titulo: 'Misi√≥n 1: El Le√≥n de Bronce',
        pista: 'Busca al guardi√°n de bronce frente al Congreso.',
        hint: 'üîç Frente al Congreso, busca la estatua ecuestre del General Belgrano.',
        coords: [-34.6034, -58.3845],
        nivel: 'N2'
      },
      'AVELLANEDA': {
        misionId: 'M2',
        titulo: 'Misi√≥n 2: El Eco de Sarand√≠',
        pista: 'En la estaci√≥n que lleva el nombre de un pueblo olvidado, busca el mural que cuenta la historia del lugar.',
        hint: 'üîç Estaci√≥n Sarand√≠, hall mural hist√≥rico en and√©n norte.',
        coords: [-34.6620, -58.3660],
        nivel: 'N2'
      },
      'LANUS': {
        misionId: 'M3',
        titulo: 'Misi√≥n 3: El Secreto del Parque',
        pista: 'Bajo la sombra del √°rbol centenario, una placa recuerda al fundador. ¬øQu√© a√±o dice?',
        hint: 'üîç Parque Juan de Garay, junto a la fuente central.',
        coords: [-34.7100, -58.3900],
        nivel: 'N2'
      },
      'LOMAS': {
        misionId: 'M4',
        titulo: 'Misi√≥n 4: La Clave de la Plaza',
        pista: 'En la plaza donde los ni√±os juegan y los ancianos recuerdan, busca el reloj de sol. ¬øQu√© hora marca siempre?',
        hint: 'üîç Plaza Manuel Belgrano, junto al monumento al fundador.',
        coords: [-34.7520, -58.4100],
        nivel: 'N2'
      }
    };

    // ========== INICIALIZACI√ìN ==========
    if (!localStorage.getItem('lastHunterId')) {
      localStorage.setItem('lastHunterId', '0');
    }

    const urlParams = new URLSearchParams(window.location.search);
    let hunterId = urlParams.get('id') || localStorage.getItem('currentHunterId') || 'hunter0000';
    let ciudadFromURL = (urlParams.get('zona') || '').trim().toUpperCase();

    // Redirigir a registro si no hay sesi√≥n v√°lida
    if (!hunterId || hunterId === 'hunter0000') {
      if (!urlParams.has('id')) {
        window.location.href = 'registro.html';
      }
    }

    let jugador;
    if (hunterId === 'hunter0000') {
      const nextId = parseInt(localStorage.getItem('lastHunterId') || '0') + 1;
      hunterId = `hunter_${String(nextId).padStart(4, '0')}`;
      localStorage.setItem('lastHunterId', nextId);
      
      const ciudad = ciudadFromURL || 'CABA';
      jugador = {
        id: hunterId,
        nombre: 'Jugador de Prueba',
        telefono: '+5491112345678',
        zona: ciudad,
        modo: 'individual'
      };
      localStorage.setItem(`jugador_${hunterId}`, JSON.stringify(jugador));
    } else {
      jugador = JSON.parse(localStorage.getItem(`jugador_${hunterId}`)) || {
        id: hunterId,
        zona: 'CABA',
        modo: 'individual'
      };
      
      let zonaFinal = 'CABA';
      if (ciudadFromURL && ZONA_CONFIG[ciudadFromURL]) {
        zonaFinal = ciudadFromURL;
      } else if (jugador.zona && ZONA_CONFIG[jugador.zona.trim().toUpperCase()]) {
        zonaFinal = jugador.zona.trim().toUpperCase();
      }
      jugador.zona = zonaFinal;
      localStorage.setItem(`jugador_${hunterId}`, JSON.stringify(jugador));
    }

    if (!ZONA_CONFIG[jugador.zona]) {
      jugador.zona = 'CABA';
      localStorage.setItem(`jugador_${hunterId}`, JSON.stringify(jugador));
    }

    localStorage.setItem('currentHunterId', hunterId);
    const isTeam = jugador.modo === 'equipo';
    const progreso = JSON.parse(localStorage.getItem(`progreso_${hunterId}`)) || {
      misiones: 0,
      desafios: 0,
      zona: jugador.zona
    };
    const config = ZONA_CONFIG[jugador.zona] || ZONA_CONFIG['CABA'];

    document.getElementById('hunterIdDisplay').textContent = isTeam 
      ? `üë• ${jugador.equipo || hunterId}`
      : `ID: ${hunterId}`;

    // Guardar momento de inicio para calcular tiempo
    const missionStartTime = Date.now();

    // ========== FLUJO INDIVIDUAL ==========
    function showPhase1() {
      document.querySelector('#phase1-consigna .mission-card').innerHTML = `
        <div class="mission-title">
          <span class="icon">ü¶Å</span>
          ${config.titulo}
        </div>
        <div class="tension-bar" style="margin: 1rem 0; background: rgba(255,69,58,0.15);">
          ‚è≥ Listo para cazar
        </div>
        <p class="pista">${config.pista}</p>
        <button class="btn btn-primary" id="start-mission-btn">‚úÖ Aceptar y comenzar</button>
      `;
      document.getElementById('phase1-consigna').style.display = 'block';
      
      document.getElementById('start-mission-btn').addEventListener('click', () => {
        startTimer(); // ‚úÖ Inicia SOLO al aceptar
        guardarProgreso(config.misionId);
        showPhase2();
      });
    }

    function showPhase2() {
      document.getElementById('phase1-consigna').style.display = 'none';
      document.querySelector('#phase2-mapa .mission-card').innerHTML = `
        <h3>üìç Ac√©rcate al objetivo</h3>
        <p style="margin: 1rem 0; color:#cbd5e1;">El radar te gu√≠a. Cuando est√©s a menos de 50 metros, se desbloquear√° la pista final.</p>
        <div id="mapApprox" style="height: 300px; border-radius:12px; margin:1rem 0;"></div>
        <button class="btn btn-outline" id="confirm-location-btn">üë£ Estoy en el lugar</button>
      `;
      document.getElementById('phase2-mapa').style.display = 'block';
      loadApproxMap();
      document.getElementById('confirm-location-btn').addEventListener('click', () => {
        showPhase3();
      });
    }

    function showPhase3() {
      document.getElementById('phase2-mapa').style.display = 'none';
      const recoveryCode = generarRecoveryCode();
      localStorage.setItem(`recovery_${hunterId}`, recoveryCode);
      
      document.querySelector('#phase3-pista .mission-card').innerHTML = `
        <h3>üîç Pista final</h3>
        <p class="pista">${config.hint}</p>
        <div class="actions">
          <button class="btn btn-primary" id="scan-btn">üîç Escanear QR</button>
        </div>
        <div style="margin-top:1.2rem; font-size:0.9rem;">
          üîë C√≥digo de recuperaci√≥n: <code>${recoveryCode}</code>
        </div>
      `;
      document.getElementById('phase3-pista').style.display = 'block';
      document.getElementById('scan-btn').addEventListener('click', openQRScanner);
      playNarration(`Cazador ${hunterId.replace('hunter_', '')}. Est√°s en la zona. La pista final ha sido revelada.`);
    }

    // ========== FLUJO EQUIPO ==========
    function showTeamMission() {
      document.body.classList.add('modo-equipo');
      const recoveryCode = generarRecoveryCode();
      localStorage.setItem(`recovery_${hunterId}`, recoveryCode);
      
      document.querySelector('#teamSection .mission-card').innerHTML = `
        <div class="mission-title">
          <span class="icon">üëÅÔ∏è</span>
          ${config.titulo}
          <span class="status active nivel-N2">ACTIVA ‚Ä¢ N2</span>
        </div>
        <p class="pista">${config.pista}</p>
        <div class="actions">
          <button class="btn btn-primary" id="accept-mission-btn">‚úÖ Aceptar misi√≥n</button>
          <button class="btn btn-outline" id="scan-btn-team">üîç Escanear QR</button>
        </div>
        <div style="margin-top:1.2rem; font-size:0.9rem;">
          üîë C√≥digo de recuperaci√≥n: <code>${recoveryCode}</code>
        </div>
      `;
      document.getElementById('teamSection').style.display = 'block';

      document.getElementById('accept-mission-btn').addEventListener('click', () => {
        guardarProgreso(config.misionId);
        showToast("‚úÖ Misi√≥n aceptada. ¬°Buena cacer√≠a!");
      });

      document.getElementById('scan-btn-team').addEventListener('click', openQRScanner);
    }

    // === FASE 4: Misi√≥n completada ===
    function showMissionCompleted() {
      document.getElementById('phase1-consigna').style.display = 'none';
      document.getElementById('phase2-mapa').style.display = 'none';
      document.getElementById('phase3-pista').style.display = 'none';
      document.getElementById('teamSection').style.display = 'none';

      const elapsedMinutes = Math.floor((Date.now() - missionStartTime) / 60000);
      const recoveryCode = localStorage.getItem(`recovery_${hunterId}`) || '‚Äî';

      document.querySelector('#phase4-completed .mission-card').innerHTML = `
        <h2 style="color:#ffd700; margin-bottom:1rem;">‚úÖ Operaci√≥n Completada</h2>
        <p><strong>${config.titulo}</strong></p>
        <p style="font-size:0.95rem; color:#cbd5e1; margin:1rem 0;">
          Tu posici√≥n ha sido registrada en el sistema central.
        </p>
        <div style="margin:1.5rem 0; font-size:0.9rem; color:#64b5f7;">
          ‚è±Ô∏è Completado en: <strong>${elapsedMinutes} min</strong>
        </div>
        <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:1.5rem;">
          üîë C√≥digo: <code>${recoveryCode}</code>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="new-mission-btn">üîÅ Nueva operaci√≥n</button>
          <button class="btn btn-outline" id="view-progress-btn">üìä Ver progreso</button>
        </div>
      `;
      document.getElementById('phase4-completed').style.display = 'block';

      document.getElementById('new-mission-btn').addEventListener('click', () => {
        window.location.href = 'registro.html';
      });

      document.getElementById('view-progress-btn').addEventListener('click', () => {
        window.location.href = 'progreso.html';
      });
    }

    // ========== TEMPORIZADOR (inicia solo al aceptar) ==========
    function startTimer() {
      document.getElementById('timer').textContent = "90:00";
      let timeLeft = 90 * 60;
      const timerEl = document.getElementById('timer');
      const interval = setInterval(() => {
        if (timeLeft <= 0) {
          timerEl.textContent = "‚è∞ Caducada";
          clearInterval(interval);
          return;
        }
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        timeLeft--;
      }, 1000);
    }

    // ========== UTILIDADES COMPARTIDAS ==========
    function loadApproxMap() {
      if (!window.L) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(link);
        
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        script.onload = () => initApproxMap();
        document.head.appendChild(script);
      } else {
        initApproxMap();
      }
    }

    function initApproxMap() {
      const coords = config.coords || [-34.6034, -58.3845];
      const map = L.map('mapApprox').setView(coords, 18.5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      
      L.marker(coords).addTo(map).bindPopup(`<strong>${config.titulo}</strong><br>Objetivo`);
    }

    function generarRecoveryCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = 'LH';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function guardarProgreso(misionId = null, desafioId = null) {
      const key = `progreso_${hunterId}`;
      let data = JSON.parse(localStorage.getItem(key) || '{}');
      if (!data.misiones) data.misiones = 0;
      if (!data.desafios) data.desafios = 0;
      if (!data.zona) data.zona = jugador.zona;
      
      if (misionId) {
        const misionesKey = `misiones_aceptadas_${hunterId}`;
        let misiones = JSON.parse(localStorage.getItem(misionesKey) || '[]');
        if (!misiones.includes(misionId)) {
          misiones.push(misionId);
          localStorage.setItem(misionesKey, JSON.stringify(misiones));
          data.misiones = misiones.length;
        }
      }
      if (desafioId) {
        const desafiosKey = `desafios_completados_${hunterId}`;
        let desafios = JSON.parse(localStorage.getItem(desafiosKey) || '[]');
        if (!desafios.includes(desafioId)) {
          desafios.push(desafioId);
          localStorage.setItem(desafiosKey, JSON.stringify(desafios));
          data.desafios = desafios.length;
        }
      }
      data.zona = jugador.zona;
      data.lastUpdate = Date.now();
      localStorage.setItem(key, JSON.stringify(data));
    }

    function playNarration(text) {
      if (localStorage.getItem('lh_narration_off') === '1') return;

      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.62;
      u.pitch = 0.4;
      u.volume = 0.95;

      const loadVoice = () => {
        const voices = speechSynthesis.getVoices();
        const voice = voices.find(v => 
          v.lang.includes('es') && 
          (v.name.includes('Male') || v.name === 'Diego' || v.name === 'Juan')
        ) || voices.find(v => v.lang.includes('es')) || null;
        
        if (voice) u.voice = voice;
      };

      loadVoice();
      speechSynthesis.addEventListener('voiceschanged', loadVoice, { once: true });

      u.onstart = () => {
        if (window.AudioContext) {
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const delay = ctx.createDelay(1.5);
            delay.delayTime.value = 0.7;
            const feedback = ctx.createGain();
            feedback.gain.value = 0.25;
            delay.connect(feedback);
            feedback.connect(delay);
            setTimeout(() => ctx.close(), 4000);
          } catch (e) {}
        }
      };

      speechSynthesis.speak(u);
    }

    document.getElementById('narration-toggle').addEventListener('click', function() {
      const isOff = localStorage.getItem('lh_narration_off') === '1';
      localStorage.setItem('lh_narration_off', isOff ? '0' : '1');
      this.textContent = isOff ? 'üîä' : 'üîá';
      showToast(isOff ? '‚úÖ Narraci√≥n activada' : 'üîá Narraci√≥n desactivada');
    });

    // ========== ESC√ÅNER QR ==========
    let scannerActive = false;
    let stream = null;

    async function openQRScanner() {
      const qrExpected = localStorage.getItem('qrCodeEsperado') || 
        `LH-${config.misionId}-${hunterId.split('_')[1]}-abcd`.toUpperCase();
      localStorage.setItem('qrCodeEsperado', qrExpected);
      
      const overlay = document.getElementById('scannerOverlay');
      const video = document.getElementById('scannerVideo');
      const canvas = document.getElementById('scannerCanvas');
      const ctx = canvas.getContext('2d');
      try {
        const constraints = { video: { facingMode: { ideal: "environment" } } };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        overlay.style.display = 'block';
        scannerActive = true;
        
        const scanInterval = setInterval(() => {
          if (!scannerActive || !video.videoWidth) return;
          ctx.drawImage(video, 0, 0, canvas.width || 640, canvas.height || 480);
          const imageData = ctx.getImageData(0, 0, canvas.width || 640, canvas.height || 480);
          const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
          if (code && code.data) {
            clearInterval(scanInterval);
            stopScanner();
            if (code.data.trim() === qrExpected) {
              const misionActiva = localStorage.getItem('misionActivaId') || 'M1';
              guardarProgreso(null, `${misionActiva}_desafio_1`);
              
              playNarration(`Confirmado. Has completado la misi√≥n. El ranking se actualiza ahora.`);
              showToast(`‚úÖ ¬°C√≥digo verificado!\nüî• ¬°Cazador ${hunterId} ha completado ${config.titulo}!`);
              
              showMissionCompleted();
            } else {
              showToast("‚ùå C√≥digo incorrecto. ¬øEst√°s en el lugar correcto?");
              setTimeout(() => scannerActive && (overlay.style.display = 'block'), 1500);
            }
          }
        }, 300);
      } catch (err) {
        stopScanner();
        showToast("‚ö†Ô∏è Error de c√°mara. Usa ingreso manual.");
      }
    }

    function stopScanner() {
      scannerActive = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      document.getElementById('scannerOverlay').style.display = 'none';
    }

    document.getElementById('closeScannerBtn')?.addEventListener('click', stopScanner);
    document.getElementById('manualInputBtn')?.addEventListener('click', () => {
      stopScanner();
      const qrExpected = localStorage.getItem('qrCodeEsperado');
      if (!qrExpected) return showToast("‚ö†Ô∏è Acepta una misi√≥n primero");
      const input = prompt("Ingresa el c√≥digo QR:", "");
      if (!input) return;
      if (input.trim() === qrExpected) {
        const misionActiva = localStorage.getItem('misionActivaId') || 'M1';
        guardarProgreso(null, `${misionActiva}_desafio_1`);
        playNarration(`Confirmado. Has completado la misi√≥n.`);
        showToast(`‚úÖ ¬°C√≥digo verificado!\nüî• ¬°Cazador ${hunterId} ha completado ${config.titulo}!`);
        
        showMissionCompleted();
      } else {
        showToast("‚ùå C√≥digo inv√°lido. ¬øEst√°s en el lugar correcto?");
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && scannerActive) stopScanner();
    });

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3500);
    }

    // ========== CONEXI√ìN EN TIEMPO REAL ==========
    let ws;
    function connectWebSocket() {
      const wsUrl = window.location.hostname === 'localhost' 
        ? 'ws://localhost:8080'
        : `wss://${window.location.hostname}/ws`;
      try {
        ws = new WebSocket(wsUrl);
        ws.onopen = () => {
          ws.send(JSON.stringify({ 
            type: 'join', 
            id: hunterId, 
            zone: jugador.zona,
            missions: progreso.misiones,
            challenges: progreso.desafios
          }));
        };
      } catch (e) {}
    }
    connectWebSocket();

    // ========== BOT√ìN DE INSTALACI√ìN PWA ==========
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    function showInstallBanner() {
      const banner = document.getElementById('pwa-install-banner');
      if (!banner) return;

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                        || window.navigator.standalone === true;

      if (isStandalone) return;

      setTimeout(() => {
        banner.style.display = 'block';
        
        if (isIOS) {
          banner.innerHTML = `
            <p style="margin:0 0 8px;font-size:0.95rem;">
              üëÜ Toca <strong>Compartir</strong> ‚Üí <strong>‚ÄúA√±adir a pantalla de inicio‚Äù</strong>
            </p>
            <button id="dismiss-ios" style="
              background:#444; color:white; border:none;
              padding:6px 12px; border-radius:6px; font-size:0.9rem;
            ">Entendido</button>
          `;
          document.getElementById('dismiss-ios').onclick = () => banner.style.display = 'none';
        } else {
          banner.innerHTML = `
            <p style="margin:0 0 8px;font-size:0.95rem;">
              üì• ¬øAgregar Let's Hunt a tu pantalla de inicio?
            </p>
            <button id="install-btn" style="
              background:var(--primary); color:white; border:none;
              padding:6px 12px; border-radius:6px; font-weight:bold;
              font-size:0.9rem;
            ">Instalar</button>
          `;
          document.getElementById('install-btn').onclick = () => {
            if (deferredPrompt) {
              deferredPrompt.prompt();
              deferredPrompt = null;
            } else {
              banner.innerHTML = `
                <p style="margin:0 0 8px;font-size:0.95rem;">
                  Abre el men√∫ del navegador (‚ãØ o ‚â°) y busca <strong>‚ÄúInstalar app‚Äù</strong>.
                </p>
                <button id="dismiss-android" style="
                  background:#444; color:white; border:none;
                  padding:6px 12px; border-radius:6px; font-size:0.9rem;
                ">Cerrar</button>
              `;
              document.getElementById('dismiss-android').onclick = () => banner.style.display = 'none';
            }
          };
        }
      }, 3000);
    }

    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(() => console.log('‚úÖ SW registrado'))
          .catch(err => console.error('‚ùå Error SW:', err));
      });
    }

    // Mostrar banner de instalaci√≥n
    showInstallBanner();

    // ========== INICIAR FLUJO ==========
    if (isTeam) {
      showTeamMission();
    } else {
      showPhase1();
    }
  </script>
</body>
</html>