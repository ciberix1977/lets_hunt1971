<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Letâ€™s Hunt Â· App</title>
  <meta name="description" content="Tu cacerÃ­a urbana en el Gran Buenos Aires" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Firebase SDK (legacy v8.10.1) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  
  <!-- LibrerÃ­as externas -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="/manifest.json">

  <meta name="theme-color" content="#000000">

  <!-- Estilos especÃ­ficos para la secciÃ³n de sponsors -->
  <style>
  /* Estilos especÃ­ficos para la secciÃ³n de sponsors en app.html */
  .sponsor-mission {
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid #ff6b6b;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .sponsor-mission-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .sponsor-mission-title {
    font-weight: bold;
    color: #f8fafc;
    margin: 0;
  }
  .sponsor-badge {
    background: linear-gradient(135deg, #ff6b6b, #ff8e53);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-left: 8px;
  }
  .sponsor-logo {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    padding: 4px;
  }
  </style>
 
</head>
<body>
 <header>
    <div class="header-left">
      <div class="tension-bar" id="tension-bar">â³ <span id="timer">Listo</span></div>
    </div>
    <div class="header-center">
      <img src="logo.webp" alt="Letâ€™s Hunt" class="app-logo">
    </div>
    <div class="header-right">
      <div class="hunter-id" id="hunterIdDisplay">ID: hunter0000</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- FASE 1: Consigna inicial -->
      <div id="phase1-consigna" class="mission-phase">
        <div class="mission-card"></div>
      </div>

      <!-- FASE 2: Mapa de aproximaciÃ³n -->
      <div id="phase2-mapa" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
        <div id="proximity-status" style="text-align:center; margin-top:1rem; color:#64b5f7; font-size:0.9rem;"></div>
      </div>

      <!-- FASE 3: Pista final + QR -->
      <div id="phase3-pista" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
      </div>

      <!-- FASE 4: MisiÃ³n completada -->
      <div id="phase4-completed" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
      </div>

      <!-- SECCIÃ“N PARA EQUIPOS -->
      <div id="teamSection" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
        <div id="team-proximity-status" style="text-align:center; margin-top:1rem; color:#64b5f7; font-size:0.9rem;"></div>
      </div>

      <!-- SECCIÃ“N DE MISIONES SPONSOR (NUEVO CON IMÃGENES Y BOTÃ“N DE RETORNO) -->
      <div id="sponsorSection" class="mission-phase" style="display: none;">
        <div class="mission-card">
          <h2 style="color:#ff6b6b; margin-bottom:1.2rem;">ğŸ¯ Misiones Sponsor</h2>
          <p style="margin-bottom:1.5rem; color:#cbd5e1;">
            DescubrÃ­ cÃ³mo marcas lÃ­deres se integran en la cacerÃ­a urbana.
            <br><em>Estas son misiones de demostraciÃ³n para sponsors.</em>
          </p>
          
          <div class="sponsor-mission" style="background:rgba(255,107,107,0.1); border:1px solid #ff6b6b; border-radius:12px; padding:16px; margin-bottom:16px;">
            <div class="sponsor-mission-header">
              <div>
                <div class="sponsor-mission-title">ğŸª Carrefour Â· LanÃºs</div>
                <span class="sponsor-badge">DEMO</span>
              </div>
              <img src="sponsors-carrefour.webp" alt="Carrefour" class="sponsor-logo">
            </div>
            <p style="font-size:0.95rem; margin:0 0 12px;">Busca el producto que guarda el sabor del pasado. Su cÃ³digo de barras es tu llave.</p>
            <button class="btn btn-outline" style="font-size:0.9rem; padding:6px 12px;">ğŸ“ Ver ubicaciÃ³n</button>
          </div>

          <div class="sponsor-mission" style="background:rgba(29,161,242,0.1); border:1px solid #1da1f2; border-radius:12px; padding:16px; margin-bottom:16px;">
            <div class="sponsor-mission-header">
              <div>
                <div class="sponsor-mission-title">ğŸ‘Ÿ Nike Â· CABA</div>
                <span class="sponsor-badge">DEMO</span>
              </div>
               <img src="sponsors-nike.webp" alt="Nike" class="sponsor-logo">
            </div>
            <p style="font-size:0.95rem; margin:0 0 12px;">La huella del cazador estÃ¡ en la suela del maniquÃ­. EscanÃ©ala antes de que desaparezca.</p>
            <button class="btn btn-outline" style="font-size:0.9rem; padding:6px 12px;">ğŸ“ Ver ubicaciÃ³n</button>
          </div>

          <div class="sponsor-mission" style="background:rgba(255,200,0,0.1); border:1px solid #ffc800; border-radius:12px; padding:16px; margin-bottom:16px;">
            <div class="sponsor-mission-header">
              <div>
                <div class="sponsor-mission-title">â›½ YPF Â· Avellaneda</div>
                <span class="sponsor-badge">DEMO</span>
              </div>
              <img src="sponsors-ypf.webp" alt="YPF" class="sponsor-logo">
            </div>
            <p style="font-size:0.95rem; margin:0 0 12px;">El surtidor 3 tiene memoria. Busca el nÃºmero que nadie ve.</p>
            <button class="btn btn-outline" style="font-size:0.9rem; padding:6px 12px;">ğŸ“ Ver ubicaciÃ³n</button>
          </div>

          <div style="margin-top:24px; padding-top:20px; border-top:1px solid var(--surface-border);">
            <h3 style="margin-bottom:12px;">Â¿QuerÃ©s que tu marca estÃ© aquÃ­?</h3>
            <p style="font-size:0.9rem; color:#94a3b8; margin-bottom:16px;">
              Ofrecemos integraciones orgÃ¡nicas, no intrusivas, con recompensas reales para hunters.
            </p>
            <a href="mailto:contacto@letshunt.ar?subject=Sponsor%20Let%E2%80%99s%20Hunt" class="btn btn-primary" style="display:inline-block;">
              ğŸ“© Contactar para patrocinar
            </a>
          </div>

          <!-- BOTÃ“N DE RETORNO A LA MISIÃ“N ACTIVA -->
          <div style="margin-top:24px; text-align:center;">
            <button class="btn btn-outline" id="back-to-mission-btn" style="padding:8px 20px;">
              ğŸ”™ Volver a mi misiÃ³n
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de invitaciÃ³n (equipo) -->
  <div id="inviteModal" class="modal-overlay">
    <div class="modal-content">
      <h3>ğŸ‘¥ Invitar a tu equipo</h3>
      <p>CompartÃ­ este cÃ³digo para que otros se unan:</p>
      <div id="codigoInvitacion">CARGANDO...</div>
      <div class="modal-actions">
        <button id="copyCodeBtn" class="btn btn-outline">ğŸ“‹ Copiar cÃ³digo</button>
        <button id="shareWaBtn" class="btn btn-primary">ğŸ’¬ WhatsApp</button>
      </div>
      <button id="closeModalBtn" class="modal-close">Cerrar</button>
    </div>
  </div>

  <!-- EscÃ¡ner QR -->
  <div id="scannerOverlay" class="modal-overlay">
    <div class="scanner-container">
      <h3>ğŸ” Escanea el CÃ³digo QR</h3>
      <video id="scannerVideo" autoplay playsinline></video>
      <canvas id="scannerCanvas" style="display: none;"></canvas>
      
      <div class="scanner-frame">
        <div class="scanner-corner tl"></div>
        <div class="scanner-corner tr"></div>
        <div class="scanner-corner bl"></div>
        <div class="scanner-corner br"></div>
      </div>

      <div class="scanner-actions">
        <button id="closeScannerBtn" class="btn btn-outline">âŒ Cancelar</button>
        <button id="manualInputBtn" class="btn btn-primary">âŒ¨ï¸ Ingresar manualmente</button>
      </div>
    </div>
  </div>

  <!-- NAVEGACIÃ“N MÃ“VIL (con nueva opciÃ³n) -->
  <nav class="mobile-nav">
    <a href="progreso.html#radar"><i>ğŸ“¡</i>SeÃ±al</a>
    <a href="#misiones"><i>ğŸ¯</i>Misiones</a>
    <a href="#scan" id="nav-scan"><i>ğŸ”</i>Escanear</a>
    <a href="progreso.html"><i>ğŸ“Š</i>Progreso</a>
    <a href="#sponsors" id="nav-sponsors"><i>ğŸ¢</i>Sponsors</a>
  </nav>

  <!-- CONTROLES GLOBALES -->
  <button id="narration-toggle" title="Activar/Desactivar narraciÃ³n">ğŸ”Š</button>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- BOTÃ“N DE ACCESIBILIDAD -->
  <button id="accessibility-toggle" title="Modo normal" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 999;
  ">ğŸ‘ï¸</button>

  <!-- Contenedor del banner de instalaciÃ³n -->
  <div id="pwa-install-banner"></div>

  <!-- LÃ“GICA PRINCIPAL -->
  <script>
    // ========== FIREBASE ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDvMo1LPD_FGk-Ahju8oN7WEn9w0B5bqUE",
      authDomain: "let-s-hunt.firebaseapp.com",
      databaseURL: "https://let-s-hunt-default-rtdb.firebaseio.com",
      projectId: "let-s-hunt",
      storageBucket: "let-s-hunt.firebasestorage.app",
      messagingSenderId: "787017812046",
      appId: "1:787017812046:web:da098b2361df4dda995b1f",
      measurementId: "G-07SR9WR8NV"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const analytics = firebase.analytics();

    // ========== ACCESIBILIDAD EN MOVIMIENTO ==========
    let accessibilityMode = localStorage.getItem('lh_accessibility_mode') || 'normal';

    // Aplicar modo de accesibilidad
    function applyAccessibilityMode() {
      const body = document.body;
      const buttons = document.querySelectorAll('button, .btn');
      const textElements = document.querySelectorAll('p, h1, h2, h3, h4, .pista, .mission-title, .tension-bar');
      
      // Remover clases previas
      body.classList.remove('accessibility-high-contrast', 'accessibility-large-text');
      
      if (accessibilityMode === 'high-contrast') {
        // Modo exterior - alto contraste
        body.classList.add('accessibility-high-contrast');
        
        // Aplicar estilos de alto contraste
        const style = document.createElement('style');
        style.id = 'accessibility-high-contrast-styles';
        style.textContent = `
          .accessibility-high-contrast {
            background: black !important;
            color: yellow !important;
          }
          .accessibility-high-contrast .mission-card,
          .accessibility-high-contrast .modal-content,
          .accessibility-high-contrast .sponsor-mission {
            background: #111 !important;
            border: 2px solid yellow !important;
            color: yellow !important;
          }
          .accessibility-high-contrast button,
          .accessibility-high-contrast .btn {
            background: yellow !important;
            color: black !important;
            border: 2px solid yellow !important;
            font-weight: bold !important;
          }
          .accessibility-high-contrast .btn-outline {
            background: transparent !important;
            color: yellow !important;
          }
          .accessibility-high-contrast .pista,
          .accessibility-high-contrast .tension-bar {
            color: #ffaa33 !important;
          }
          .accessibility-high-contrast .hunter-id {
            color: lime !important;
            font-weight: bold !important;
          }
        `;
        document.head.appendChild(style);
      } else if (accessibilityMode === 'large-text') {
        // Modo texto grande
        body.classList.add('accessibility-large-text');
        
        const style = document.createElement('style');
        style.id = 'accessibility-large-text-styles';
        style.textContent = `
          .accessibility-large-text {
            font-size: 110% !important;
          }
          .accessibility-large-text h1 { font-size: 180% !important; }
          .accessibility-large-text h2 { font-size: 160% !important; }
          .accessibility-large-text h3 { font-size: 140% !important; }
          .accessibility-large-text h4 { font-size: 130% !important; }
          .accessibility-large-text p,
          .accessibility-large-text .pista { font-size: 120% !important; }
          .accessibility-large-text button,
          .accessibility-large-text .btn {
            padding: 12px 20px !important;
            font-size: 110% !important;
            min-height: 50px !important;
          }
          .accessibility-large-text .mission-card {
            padding: 20px !important;
          }
        `;
        document.head.appendChild(style);
      }
      
      // Actualizar botÃ³n de accesibilidad
      updateAccessibilityButton();
    }

    // Actualizar botÃ³n de accesibilidad
    function updateAccessibilityButton() {
      const btn = document.getElementById('accessibility-toggle');
      if (!btn) return;
      
      const modes = {
        'normal': 'ğŸ‘ï¸',
        'high-contrast': 'â˜€ï¸',
        'large-text': 'ğŸ…°ï¸'
      };
      
      btn.textContent = modes[accessibilityMode] || 'ğŸ‘ï¸';
      btn.title = getAccessibilityModeName(accessibilityMode);
    }

    function getAccessibilityModeName(mode) {
      const names = {
        'normal': 'Modo normal',
        'high-contrast': 'Modo exterior (alto contraste)',
        'large-text': 'Texto grande'
      };
      return names[mode] || 'Accesibilidad';
    }

    // Alternar modo de accesibilidad
    function toggleAccessibilityMode() {
      const modes = ['normal', 'high-contrast', 'large-text'];
      const currentIndex = modes.indexOf(accessibilityMode);
      const nextIndex = (currentIndex + 1) % modes.length;
      accessibilityMode = modes[nextIndex];
      
      localStorage.setItem('lh_accessibility_mode', accessibilityMode);
      
      // Limpiar estilos anteriores
      const oldStyle1 = document.getElementById('accessibility-high-contrast-styles');
      const oldStyle2 = document.getElementById('accessibility-large-text-styles');
      if (oldStyle1) oldStyle1.remove();
      if (oldStyle2) oldStyle2.remove();
      
      // Aplicar nuevo modo
      applyAccessibilityMode();
      
      showToast(`âœ… ${getAccessibilityModeName(accessibilityMode)}`);
    }

    // ========== RECUPERACIÃ“N POST-ERROR ==========
    let redemptionOffered = false;

    // Mostrar misiÃ³n de redenciÃ³n
    async function showRedemptionMission() {
      if (redemptionOffered) return;
      
      // Obtener misiÃ³n alternativa en otra zona
      const allZones = ['CABA', 'Avellaneda', 'LanÃºs', 'Lomas de Zamora'];
      const otherZones = allZones.filter(z => z !== jugador.zona);
      const randomZone = otherZones[Math.floor(Math.random() * otherZones.length)];
      
      const redemptionMission = selectRandomMission(randomZone, 'solitario');
      
      // Mostrar mensaje de redenciÃ³n
      document.querySelector('#phase1-consigna .mission-card').innerHTML = `
        <div class="mission-title">
          <span class="icon">ğŸ•Šï¸</span>
          MisiÃ³n de RedenciÃ³n
        </div>
        <div class="tension-bar" style="margin: 1rem 0; background: rgba(106, 170, 255, 0.15);">
          ğŸŒŸ Segunda oportunidad
        </div>
        <p class="pista">
          No todos los cazadores triunfan a la primera. Pero tÃº... tienes el instinto necesario.
          <br><br>
          <strong>${redemptionMission.titulo}</strong><br>
          ${redemptionMission.descripcion_narrativa || redemptionMission.pista_al_llegar}
        </p>
        <button class="btn btn-primary" id="accept-redemption-btn">âœ… Aceptar misiÃ³n de redenciÃ³n</button>
        <button class="btn btn-outline" id="retry-original-btn" style="margin-top: 10px;">ğŸ”„ Intentar original</button>
      `;
      
      redemptionOffered = true;
      
      // Eventos para botones
      document.getElementById('accept-redemption-btn').addEventListener('click', () => {
        currentMission = redemptionMission;
        jugador.zona = randomZone;
        localStorage.setItem(`jugador_${jugador.id}`, JSON.stringify(jugador));
        missionStartTime = Date.now();
        startTimer();
        guardarProgreso(currentMission.id);
        showPhase2();
      });
      
      document.getElementById('retry-original-btn').addEventListener('click', () => {
        showPhase1(); // Intentar nuevamente la misiÃ³n original
      });
    }

    // Consuelo narrativo inteligente
    function playConsolationNarration(failureReason) {
      const consolations = {
        'timeout': "El tiempo se agotÃ³, pero tu instinto de caza permanece. Hay otras presas esperando.",
        'already_completed': "Alguien fue mÃ¡s rÃ¡pido, pero eso no define tu habilidad. El verdadero cazador siempre encuentra otra oportunidad.",
        'wrong_code': "El cÃ³digo no era correcto, pero cada error te acerca mÃ¡s a la verdad. ConfÃ­a en tu instinto.",
        'general': "No todos los cazadores triunfan a la primera. Pero los verdaderos nunca se rinden."
      };
      
      const message = consolations[failureReason] || consolations.general;
      playNarration(message);
    }

    // Sugerencia inteligente basada en contexto
    function getSuggestionBasedOnContext(failureReason) {
      let suggestion = "";
      
      if (failureReason === 'timeout') {
        suggestion = "ğŸ’¡ Consejo: Prueba en horario de menor trÃ¡fico peatonal.";
      } else if (failureReason === 'already_completed') {
        suggestion = "ğŸ’¡ Consejo: Activa notificaciones para saber cuÃ¡ndo hay nuevas misiones disponibles.";
      } else if (failureReason === 'wrong_code') {
        suggestion = "ğŸ’¡ Consejo: AsegÃºrate de estar en el lugar exacto antes de escanear.";
      } else {
        suggestion = "ğŸ’¡ Consejo: Cada cacerÃ­a te hace mÃ¡s fuerte. Â¡Intenta de nuevo!";
      }
      
      return suggestion;
    }

    // ========== DATOS DINÃMICOS ==========
    let misionesSolitario = [];
    let misionesEquipo = [];
    let currentMission = null;
    let missionStartTime = null;
    let deferredPrompt;

    // ========== INICIALIZACIÃ“N ==========
    async function initApp() {
      try {
        const [solitarioRes, equipoRes] = await Promise.all([
          fetch('misiones-solitario.json'),
          fetch('misiones-equipo-local.json')
        ]);
        if (!solitarioRes.ok) throw new Error(`Error ${solitarioRes.status}: misiones-solitario.json`);
        if (!equipoRes.ok) throw new Error(`Error ${equipoRes.status}: misiones-equipo-local.json`);
        misionesSolitario = await solitarioRes.json();
        misionesEquipo = await equipoRes.json();
      } catch (err) {
        console.error("âš ï¸ Error crÃ­tico:", err);
        showToast("âš ï¸ Error al cargar misiones. Verifica los archivos JSON.");
        misionesSolitario = [
          { id: 1, zona: "CABA", titulo: "MisiÃ³n de prueba", ubicacion_mapa: "Plaza de Mayo", pista_al_llegar: "Busca la pista final.", coordenadas: { lat: -34.6037, lng: -58.3816 } }
        ];
      }
      
      // Aplicar modo de accesibilidad
      applyAccessibilityMode();
      
      setupJugador();
    }

    // ========== VERIFICACIÃ“N DE MISIÃ“N EN TIEMPO REAL ==========
    async function isMisionDisponible(misionId, zona) {
      try {
        const misionRef = db.ref(`misiones/${misionId}-${zona}`);
        const snapshot = await misionRef.once('value');
        
        if (!snapshot.exists()) {
          return true; // Disponible si no existe
        }
        
        const data = snapshot.val();
        return data.estado !== 'completada';
      } catch (err) {
        console.error("Error en Firebase:", err);
        return true; // Fallback seguro
      }
    }

    async function completarMision(misionId, zona, hunterId) {
      try {
        const misionRef = db.ref(`misiones/${misionId}-${zona}`);
        const snapshot = await misionRef.once('value');
        
        if (!snapshot.exists()) {
          // Primero en completar
          await misionRef.set({
            estado: 'completada',
            hunter_ganador: hunterId,
            timestamp: Date.now()
          });
          return true;
        }
        
        const data = snapshot.val();
        if (data.estado === 'completada') {
          return false; // Ya fue completada
        }
        
        // Marcar como completada
        await misionRef.set({
          estado: 'completada',
          hunter_ganador: hunterId,
          timestamp: Date.now()
        });
        return true;
      } catch (err) {
        console.error("Error al completar misiÃ³n:", err);
        return true; // No bloquear al jugador
      }
    }

    // FunciÃ³n para ocultar todas las fases
    function hideAllPhases() {
      document.getElementById('phase1-consigna').style.display = 'none';
      document.getElementById('phase2-mapa').style.display = 'none';
      document.getElementById('phase3-pista').style.display = 'none';
      document.getElementById('phase4-completed').style.display = 'none';
      document.getElementById('teamSection').style.display = 'none';
      document.getElementById('sponsorSection').style.display = 'none';
    }

    // Manejar navegaciÃ³n a sponsors
    document.getElementById('nav-sponsors')?.addEventListener('click', (e) => {
      e.preventDefault();
      hideAllPhases();
      document.getElementById('sponsorSection').style.display = 'block';
      window.scrollTo(0, 0);
    });

    // ========== CONFIGURACIÃ“N DEL JUGADOR ==========
    let jugador;
    let firebaseUser = null;

    function setupJugador() {
      const urlParams = new URLSearchParams(window.location.search);
      let hunterId = urlParams.get('id') || localStorage.getItem('currentHunterId');

      // Iniciar sesiÃ³n anÃ³nima
      auth.signInAnonymously().catch((error) => {
        console.error("Error al iniciar sesiÃ³n anÃ³nima:", error);
      });

      auth.onAuthStateChanged((user) => {
        if (user) {
          firebaseUser = user;
          localStorage.setItem('firebaseUid', user.uid);
          
          // Generar hunterId basado en UID
          hunterId = `hunter_${user.uid.substring(0, 8)}`;
          localStorage.setItem('currentHunterId', hunterId);
          
          _continueSetupJugador(hunterId);
        } else {
          _continueSetupJugador(hunterId);
        }
      });
    }

    function _continueSetupJugador(hunterId) {
      if (!hunterId) {
        const nextId = parseInt(localStorage.getItem('lastHunterId') || '0') + 1;
        hunterId = `hunter_${String(nextId).padStart(4, '0')}`;
        localStorage.setItem('lastHunterId', nextId);
        
        const ciudadFromURL = decodeURIComponent((new URLSearchParams(window.location.search).get('zona') || 'CABA').replace(/\+/g, ' ')).trim();
        jugador = {
          id: hunterId,
          nombre: 'Jugador de Prueba',
          telefono: '+5491112345678',
          zona: ciudadFromURL,
          modo: 'individual'
        };
        localStorage.setItem(`jugador_${hunterId}`, JSON.stringify(jugador));
        localStorage.setItem('currentHunterId', hunterId);
      } else {
        // Manejo seguro de localStorage
        let storedJugador;
        try {
          storedJugador = JSON.parse(localStorage.getItem(`jugador_${hunterId}`));
        } catch (e) {
          console.warn("Datos corruptos en localStorage. Reiniciando jugador.");
          storedJugador = null;
        }

        jugador = storedJugador || {
          id: hunterId,
          zona: 'CABA',
          modo: 'individual'
        };

        const ciudadFromURL = decodeURIComponent((new URLSearchParams(window.location.search).get('zona') || '').replace(/\+/g, ' ')).trim();
        if (ciudadFromURL) {
          const zonaNormalizada = ciudadFromURL.normalize('NFC');
          if (getMisionesByZona(zonaNormalizada, 'solitario').length > 0) {
            jugador.zona = zonaNormalizada;
          }
        }

        localStorage.setItem(`jugador_${hunterId}`, JSON.stringify(jugador));
        localStorage.setItem('currentHunterId', hunterId);
      }

      document.getElementById('hunterIdDisplay').textContent = 
        jugador.modo === 'equipo' ? `ğŸ‘¥ ${jugador.equipo || hunterId}` : `ID: ${hunterId}`;

      // Resetear estado de redenciÃ³n
      redemptionOffered = false;

      // Mostrar la misiÃ³n correspondiente
      if (jugador.modo === 'equipo') {
        showTeamMission();
      } else {
        showPhase1();
      }
    }

    // ========== UTILIDADES DE MISIÃ“N ==========
    function getMisionesByZona(zona, tipo = 'solitario') {
      const lista = tipo === 'equipo' ? misionesEquipo : misionesSolitario;
      
      const zonaNormalizada = (zona || '').trim().toLowerCase();
      
      const barriosCABA = [
        'san telmo', 'la boca', 'recoleta', 'microcentro', 'palermo',
        'congreso', 'almagro', 'retiro', 'balvanera', 'villa crespo',
        'belgrano', 'barracas', 'flores', 'villa urquiza', 'puerto madero',
        'san cristÃ³bal'
      ];
      
      return lista.filter(m => {
        const misionZona = (m.zona || '').trim().toLowerCase();
        
        if (misionZona === zonaNormalizada) {
          return true;
        }
        
        if (zonaNormalizada === 'caba' && barriosCABA.includes(misionZona)) {
          return true;
        }
        
        if (barriosCABA.includes(zonaNormalizada) && barriosCABA.includes(misionZona)) {
          return true;
        }
        
        return false;
      });
    }

    function selectRandomMission(zona, tipo = 'solitario') {
      const misiones = getMisionesByZona(zona, tipo);
      if (misiones.length === 0) {
        return getMisionesByZona('CABA', tipo)[0] || misionesSolitario[0];
      }
      return misiones[Math.floor(Math.random() * misiones.length)];
    }

    // ========== FLUJO INDIVIDUAL ==========
    async function showPhase1() {
      currentMission = selectRandomMission(jugador.zona, 'solitario');
      
      // Registrar evento de Analytics
      analytics.logEvent('mision_aceptada', {
        zona: jugador.zona,
        tipo: 'solitario',
        hunter_id: jugador.id
      });
      
      // Verificar disponibilidad en tiempo real
      const disponible = await isMisionDisponible(currentMission.id, jugador.zona);
      if (!disponible) {
        // Mostrar consuelo narrativo
        playConsolationNarration('already_completed');
        
        // Mostrar sugerencia y opciÃ³n de redenciÃ³n
        document.querySelector('#phase1-consigna .mission-card').innerHTML = `
          <div class="mission-title">
            <span class="icon">âš ï¸</span>
            MisiÃ³n ya completada
          </div>
          <div class="tension-bar" style="margin: 1rem 0; background: rgba(255, 170, 51, 0.15);">
            â³ Alguien fue mÃ¡s rÃ¡pido
          </div>
          <p class="pista">
            ${getSuggestionBasedOnContext('already_completed')}
            <br><br>
            Pero no te preocupes. En Let's Hunt, cada fracaso es una lecciÃ³n.
          </p>
          <button class="btn btn-primary" id="new-mission-btn">ğŸ¯ Nueva misiÃ³n</button>
          <button class="btn btn-outline" id="redemption-btn" style="margin-top: 10px;">ğŸ•Šï¸ MisiÃ³n de redenciÃ³n</button>
        `;
        
        document.getElementById('phase1-consigna').style.display = 'block';
        
        document.getElementById('new-mission-btn').addEventListener('click', showPhase1);
        document.getElementById('redemption-btn').addEventListener('click', showRedemptionMission);
        
        return;
      }

      document.querySelector('#phase1-consigna .mission-card').innerHTML = `
        <div class="mission-title">
          <span class="icon">ğŸ¦</span>
          ${currentMission.titulo}
        </div>
        <div class="tension-bar" style="margin: 1rem 0; background: rgba(255,69,58,0.15);">
          â³ Listo para cazar
        </div>
        <p class="pista">${currentMission.descripcion_narrativa || currentMission.pista_al_llegar}</p>
        <button class="btn btn-primary" id="start-mission-btn">âœ… Aceptar y comenzar</button>
      `;
      document.getElementById('phase1-consigna').style.display = 'block';
      
      document.getElementById('start-mission-btn').addEventListener('click', () => {
        missionStartTime = Date.now();
        startTimer();
        guardarProgreso(currentMission.id);
        showPhase2();
      });
    }

    function showPhase2() {
      document.getElementById('phase1-consigna').style.display = 'none';
      document.querySelector('#phase2-mapa .mission-card').innerHTML = `
        <h3>ğŸ“ AcÃ©rcate al objetivo</h3>
        <p style="margin: 1rem 0; color:#cbd5e1; line-height: 1.4;">${currentMission.ubicacion_mapa}</p>
        <div id="mapApprox" style="height: 300px; border-radius:12px; margin:1rem 0;"></div>
        <p id="proximity-instructions" style="font-size:0.9rem; color:#94a3b8;">Esperando tu ubicaciÃ³n...</p>
        <!-- BotÃ³n de acciÃ³n grande para mÃ³viles -->
        <button class="btn btn-primary" id="back-to-phase1-btn" style="margin-top: 15px; width: 100%; padding: 12px;">
          ğŸ”™ Volver a misiÃ³n
        </button>
      `;
      document.getElementById('phase2-mapa').style.display = 'block';
      loadApproxMap(currentMission.coordenadas.lat, currentMission.coordenadas.lng);
      startProximityCheck(currentMission.coordenadas.lat, currentMission.coordenadas.lng);
      
      // Evento para botÃ³n de retroceso
      document.getElementById('back-to-phase1-btn').onclick = () => {
        document.getElementById('phase2-mapa').style.display = 'none';
        document.getElementById('phase1-consigna').style.display = 'block';
      };
    }

    function showPhase3() {
      document.getElementById('phase2-mapa').style.display = 'none';
      const recoveryCode = generarRecoveryCode();
      localStorage.setItem(`recovery_${jugador.id}`, recoveryCode);
      
      document.querySelector('#phase3-pista .mission-card').innerHTML = `
        <h3>ğŸ” Pista final</h3>
        <p class="pista">${currentMission.pista_al_llegar}</p>
        <div class="actions">
          <button class="btn btn-primary" id="scan-btn">ğŸ” Escanear QR</button>
        </div>
        <div style="margin-top:1.2rem; font-size:0.9rem;">
          ğŸ”‘ CÃ³digo de recuperaciÃ³n: <code>${recoveryCode}</code>
        </div>
      `;
      document.getElementById('phase3-pista').style.display = 'block';
      document.getElementById('scan-btn').addEventListener('click', openQRScanner);
      playNarration(`Cazador ${jugador.id.replace('hunter_', '')}. EstÃ¡s en la zona. La pista final ha sido revelada.`);
    }

    // ========== FLUJO EQUIPO ==========
    let currentTeamMission = null;
    async function showTeamMission() {
      document.body.classList.add('modo-equipo');
      currentTeamMission = selectRandomMission(jugador.zona, 'equipo');
      const recoveryCode = generarRecoveryCode();
      localStorage.setItem(`recovery_${jugador.id}`, recoveryCode);
      
      document.querySelector('#teamSection .mission-card').innerHTML = `
        <div class="mission-title">
          <span class="icon">ğŸ‘ï¸</span>
          ${currentTeamMission.titulo}
          <span class="status active nivel-N2">ACTIVA â€¢ N2</span>
        </div>
        <p class="pista">${currentTeamMission.descripcion_narrativa}</p>
        <div class="actions">
          <button class="btn btn-primary" id="accept-mission-btn">âœ… Aceptar misiÃ³n</button>
          <button class="btn btn-outline" id="scan-btn-team">ğŸ” Escanear QR</button>
        </div>
        <div style="margin-top:1.2rem; font-size:0.9rem;">
          ğŸ”‘ CÃ³digo de recuperaciÃ³n: <code>${recoveryCode}</code>
        </div>
      `;
      document.getElementById('teamSection').style.display = 'block';

      document.getElementById('accept-mission-btn').addEventListener('click', () => {
        missionStartTime = Date.now();
        startTimer();
        guardarProgreso(currentTeamMission.id);
        showToast("âœ… MisiÃ³n aceptada. Â¡Buena cacerÃ­a!");
        startTeamProximityCheck();
      });

      document.getElementById('scan-btn-team').addEventListener('click', openQRScanner);
    }

    function startTeamProximityCheck() {
      const coordsA = currentTeamMission.qr_cercanos[0].coordenadas;
      loadApproxMap(coordsA.lat, coordsA.lng);
      document.getElementById('team-proximity-status').textContent = "ğŸ“ Esperando ubicaciÃ³n...";
      
      if (navigator.geolocation) {
        const watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            const distA = calculateDistance(userLat, userLng, coordsA.lat, coordsA.lng);
            const coordsB = currentTeamMission.qr_cercanos[1]?.coordenadas;
            let statusText = `EstÃ¡s a ${distA.toFixed(0)} m del QR A`;
            if (coordsB) {
              const distB = calculateDistance(userLat, userLng, coordsB.lat, coordsB.lng);
              statusText += ` | ${distB.toFixed(0)} m del QR B`;
            }
            document.getElementById('team-proximity-status').textContent = statusText;
          },
          (err) => {
            document.getElementById('team-proximity-status').textContent = "âš ï¸ UbicaciÃ³n desactivada";
          },
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
        );
      }
    }

    // ========== VALIDACIÃ“N DE PROXIMIDAD REAL ==========
    let proximityWatchId = null;
    function startProximityCheck(targetLat, targetLng) {
      if (navigator.geolocation) {
        document.getElementById('proximity-instructions').textContent = "Verificando tu ubicaciÃ³n...";
        proximityWatchId = navigator.geolocation.watchPosition(
          (pos) => {
            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            const distance = calculateDistance(userLat, userLng, targetLat, targetLng);
            
            const statusEl = document.getElementById('proximity-status');
            if (distance <= 50) {
              statusEl.innerHTML = "âœ… Â¡EstÃ¡s en la zona! Puedes acceder a la pista final.";
              statusEl.style.color = "#4ade80";
              if (!document.getElementById('unlock-phase3-btn')) {
                const btn = document.createElement('button');
                btn.id = 'unlock-phase3-btn';
                btn.className = 'btn btn-primary';
                btn.textContent = 'ğŸ”“ Acceder a la pista final';
                btn.onclick = showPhase3;
                document.querySelector('#phase2-mapa .mission-card').appendChild(btn);
              }
            } else {
              statusEl.innerHTML = `ğŸ“ A ${Math.round(distance)} metros del objetivo. AcÃ©rcate mÃ¡s.`;
              statusEl.style.color = "#64b5f7";
              const unlockBtn = document.getElementById('unlock-phase3-btn');
              if (unlockBtn) unlockBtn.remove();
            }
          },
          (err) => {
            document.getElementById('proximity-status').textContent = "âš ï¸ No se pudo obtener tu ubicaciÃ³n. Activa GPS.";
          },
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
        );
      } else {
        document.getElementById('proximity-status').textContent = "âš ï¸ Tu navegador no soporta geolocalizaciÃ³n.";
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const Ï†1 = lat1 * Math.PI/180;
      const Ï†2 = lat2 * Math.PI/180;
      const Î”Ï† = (lat2-lat1) * Math.PI/180;
      const Î”Î» = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    // ========== MAPA ==========
    function loadApproxMap(lat, lng) {
      if (!window.L) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(link);
        
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        script.onload = () => initApproxMap(lat, lng);
        document.head.appendChild(script);
      } else {
        initApproxMap(lat, lng);
      }
    }

    function initApproxMap(lat, lng) {
      const map = L.map('mapApprox').setView([lat, lng], 18.5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      
      L.circle([lat, lng], {
        color: '#ff6b6b',
        fillColor: '#ff6b6b',
        fillOpacity: 0.15,
        radius: 50
      }).addTo(map);

      L.marker([lat, lng]).addTo(map).bindPopup(`<strong>Objetivo</strong><br>Zona de 50m`);
    }

    // ========== TEMPORIZADOR ==========
    function startTimer() {
      document.getElementById('timer').textContent = "90:00";
      let timeLeft = 90 * 60;
      const timerEl = document.getElementById('timer');
      const interval = setInterval(() => {
        if (timeLeft <= 0) {
          timerEl.textContent = "â° Caducada";
          clearInterval(interval);
          
          // Mostrar consuelo por timeout
          playConsolationNarration('timeout');
          
          // Mostrar misiÃ³n de redenciÃ³n
          setTimeout(() => {
            document.querySelector('#phase1-consigna .mission-card').innerHTML = `
              <div class="mission-title">
                <span class="icon">â°</span>
                Tiempo agotado
              </div>
              <div class="tension-bar" style="margin: 1rem 0; background: rgba(255, 170, 51, 0.15);">
                â³ La misiÃ³n ha caducado
              </div>
              <p class="pista">
                ${getSuggestionBasedOnContext('timeout')}
                <br><br>
                Pero el espÃ­ritu de caza nunca muere. Â¿Aceptas una segunda oportunidad?
              </p>
              <button class="btn btn-primary" id="redemption-timeout-btn">ğŸ•Šï¸ MisiÃ³n de redenciÃ³n</button>
              <button class="btn btn-outline" id="new-mission-timeout-btn" style="margin-top: 10px;">ğŸ¯ Nueva misiÃ³n</button>
            `;
            
            document.getElementById('phase1-consigna').style.display = 'block';
            document.getElementById('phase2-mapa').style.display = 'none';
            
            document.getElementById('redemption-timeout-btn').addEventListener('click', showRedemptionMission);
            document.getElementById('new-mission-timeout-btn').addEventListener('click', () => {
              window.location.href = 'registro.html';
            });
          }, 2000);
          
          return;
        }
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        timeLeft--;
      }, 1000);
    }

    // ========== ESCÃNER QR ==========
    let scannerActive = false;
    let stream = null;
    async function openQRScanner() {
      let qrExpected;
      if (jugador.modo === 'equipo' && currentTeamMission) {
        qrExpected = {
          A: `LH-${currentTeamMission.id}-A-${jugador.id.split('_')[1]}`,
          B: `LH-${currentTeamMission.id}-B-${jugador.id.split('_')[1]}`
        };
        localStorage.setItem('qrCodeEsperado', JSON.stringify(qrExpected));
      } else {
        qrExpected = `LH-${currentMission.id}-${jugador.id.split('_')[1]}`;
        localStorage.setItem('qrCodeEsperado', qrExpected);
      }
      
      const overlay = document.getElementById('scannerOverlay');
      const video = document.getElementById('scannerVideo');
      const canvas = document.getElementById('scannerCanvas');
      
      try {
        const constraints = { video: { facingMode: { ideal: "environment" } } };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        };
        
        overlay.style.display = 'block';
        scannerActive = true;
        
        const scanInterval = setInterval(async () => {
          if (!scannerActive || !video.videoWidth) return;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height, { inversionAttempts: "dontInvert" });
          
          if (code && code.data) {
            clearInterval(scanInterval);
            stopScanner();
            
            const codigoEscaneado = code.data.trim();
            let exito = false;
            
            if (jugador.modo === 'equipo') {
              // Para equipos, verificar QR individual
              exito = true; // Simplificado para equipos
              handleTeamQRScan(codigoEscaneado, qrExpected);
            } else {
              // Para individuales, verificar con Firebase
              if (codigoEscaneado === qrExpected) {
                exito = await completarMision(currentMission.id, jugador.zona, jugador.id);
              }
            }
            
            if (!exito && jugador.modo !== 'equipo') {
              analytics.logEvent('qr_escaneo_fallido', {
                zona: jugador.zona,
                hunter_id: jugador.id
              });
              showToast("âŒ Â¡Demasiado tarde! Alguien ya encontrÃ³ el cÃ³digo.");
              setTimeout(showPhase1, 3000);
              return;
            }
            
            if (exito || jugador.modo === 'equipo') {
              completeMission();
            } else {
              showToast("âŒ CÃ³digo incorrecto. Â¿EstÃ¡s en el lugar correcto?");
              setTimeout(() => scannerActive && (overlay.style.display = 'block'), 1500);
            }
          }
        }, 300);
      } catch (err) {
        stopScanner();
        showToast("âš ï¸ Error de cÃ¡mara. Usa ingreso manual.");
      }
    }

    // âœ… MANEJO DE RESULTADOS (con soporte offline)
    async function handleScanResult(success, scannedCode) {
      if (jugador.modo === 'equipo') {
        return;
      }
      
      if (!success) {
        const expectedPattern = new RegExp(`^LH-${currentMission.id}-[0-9]{8}$`);
        if (expectedPattern.test(scannedCode)) {
          // CÃ³digo vÃ¡lido pero ya usado
          if (isOnline) {
            analytics.logEvent('qr_escaneo_fallido', {
              zona: jugador.zona,
              hunter_id: jugador.id,
              motivo: 'ya_usado'
            });
            playConsolationNarration('already_completed');
            showToast("âŒ Â¡Demasiado tarde! Este cÃ³digo ya fue usado.");
            
            // Mostrar opciones de recuperaciÃ³n
            setTimeout(() => {
              document.querySelector('#phase1-consigna .mission-card').innerHTML = `
                <div class="mission-title">
                  <span class="icon">âŒ</span>
                  CÃ³digo ya utilizado
                </div>
                <div class="tension-bar" style="margin: 1rem 0; background: rgba(255, 170, 51, 0.15);">
                  â³ Demasiado tarde
                </div>
                <p class="pista">
                  ${getSuggestionBasedOnContext('already_completed')}
                  <br><br>
                  Pero los verdaderos cazadores siempre encuentran otra presa.
                </p>
                <button class="btn btn-primary" id="redemption-used-btn">ğŸ•Šï¸ MisiÃ³n de redenciÃ³n</button>
                <button class="btn btn-outline" id="new-mission-used-btn" style="margin-top: 10px;">ğŸ¯ Nueva misiÃ³n</button>
              `;
              
              document.getElementById('phase1-consigna').style.display = 'block';
              document.getElementById('phase3-pista').style.display = 'none';
              
              document.getElementById('redemption-used-btn').addEventListener('click', showRedemptionMission);
              document.getElementById('new-mission-used-btn').addEventListener('click', () => {
                window.location.href = 'registro.html';
              });
            }, 3000);
          } else {
            // Offline: asumir que es vÃ¡lido y procesar al reconectar
            showToast("âœ… CÃ³digo escaneado. Se validarÃ¡ al recuperar conexiÃ³n.");
            completeMission();
          }
        } else {
          analytics.logEvent('qr_escaneo_fallido', {
            zona: jugador.zona,
            hunter_id: jugador.id,
            motivo: 'codigo_incorrecto'
          });
          playConsolationNarration('wrong_code');
          showToast("âŒ CÃ³digo incorrecto. Â¿EstÃ¡s en el lugar correcto?");
          
          // Mostrar sugerencia inmediata
          setTimeout(() => {
            showToast(getSuggestionBasedOnContext('wrong_code'));
          }, 2000);
          
          setTimeout(showPhase1, 5000);
        }
        return;
      }
      
      // Ã‰xito
      completeMission();
    }

    function handleTeamQRScan(scannedCode, expectedCodes) {
      const key = `teamScan_${jugador.id}_${currentTeamMission.id}`;
      let scans = JSON.parse(localStorage.getItem(key) || '{}');
      
      if (scannedCode === expectedCodes.A) {
        scans.A = Date.now();
        localStorage.setItem(key, JSON.stringify(scans));
        showToast("âœ… QR A escaneado. Â¡Ahora busca el QR B!");
      } else if (scannedCode === expectedCodes.B) {
        scans.B = Date.now();
        localStorage.setItem(key, JSON.stringify(scans));
        showToast("âœ… QR B escaneado. Â¡Ahora busca el QR A!");
      }
      
      if (scans.A && scans.B) {
        const diff = Math.abs(scans.B - scans.A);
        if (diff <= 15000) {
          completeMission();
        } else {
          showToast("âŒ Los escaneos no fueron sincronizados. IntÃ©ntalo de nuevo.");
        }
      }
    }

    function completeMission() {
      const misionId = jugador.modo === 'equipo' ? currentTeamMission.id : currentMission.id;
      guardarProgreso(null, `${misionId}_desafio_1`);
      
      // Registrar evento de Analytics
      analytics.logEvent('mision_completada', {
        zona: jugador.zona,
        tipo: jugador.modo,
        hunter_id: jugador.id,
        tiempo_min: Math.floor((Date.now() - missionStartTime) / 60000)
      });
      
      playNarration(`Confirmado. Has completado la misiÃ³n. El ranking se actualiza ahora.`);
      showToast(`âœ… Â¡CÃ³digo verificado!\nğŸ”¥ Â¡Cazador ${jugador.id} ha completado la misiÃ³n!`);
      showMissionCompleted();
    }

    function stopScanner() {
      scannerActive = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      document.getElementById('scannerOverlay').style.display = 'none';
    }

    // ========== UTILIDADES COMPARTIDAS ==========
    function generarRecoveryCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = 'LH';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function guardarProgreso(misionId = null, desafioId = null) {
      const key = `progreso_${jugador.id}`;
      let data = JSON.parse(localStorage.getItem(key) || '{}');
      if (!data.misiones) data.misiones = 0;
      if (!data.desafios) data.desafios = 0;
      if (!data.zona) data.zona = jugador.zona;
      
      if (misionId) {
        const misionesKey = `misiones_aceptadas_${jugador.id}`;
        let misiones = JSON.parse(localStorage.getItem(misionesKey) || '[]');
        if (!misiones.includes(misionId)) {
          misiones.push(misionId);
          localStorage.setItem(misionesKey, JSON.stringify(misiones));
          data.misiones = misiones.length;
        }
      }
      if (desafioId) {
        const desafiosKey = `desafios_completados_${jugador.id}`;
        let desafios = JSON.parse(localStorage.getItem(desafiosKey) || '[]');
        if (!desafios.includes(desafioId)) {
          desafios.push(desafioId);
          localStorage.setItem(desafiosKey, JSON.stringify(desafios));
          data.desafios = desafios.length;
        }
      }
      data.zona = jugador.zona;
      data.lastUpdate = Date.now();
      localStorage.setItem(key, JSON.stringify(data));
    }

    function playNarration(text) {
      if (localStorage.getItem('lh_narration_off') === '1') return;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.62;
      u.pitch = 0.4;
      u.volume = 0.95;
      const loadVoice = () => {
        const voices = speechSynthesis.getVoices();
        const voice = voices.find(v => 
          v.lang.includes('es') && 
          (v.name.includes('Male') || v.name === 'Diego' || v.name === 'Juan')
        ) || voices.find(v => v.lang.includes('es')) || null;
        if (voice) u.voice = voice;
      };
      loadVoice();
      speechSynthesis.addEventListener('voiceschanged', loadVoice, { once: true });
      u.onstart = () => {
        if (window.AudioContext) {
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const delay = ctx.createDelay(1.5);
            delay.delayTime.value = 0.7;
            const feedback = ctx.createGain();
            feedback.gain.value = 0.25;
            delay.connect(feedback);
            feedback.connect(delay);
            setTimeout(() => ctx.close(), 4000);
          } catch (e) {}
        }
      };
      speechSynthesis.speak(u);
    }

    function showMissionCompleted() {
      document.getElementById('phase1-consigna').style.display = 'none';
      document.getElementById('phase2-mapa').style.display = 'none';
      document.getElementById('phase3-pista').style.display = 'none';
      document.getElementById('teamSection').style.display = 'none';

      const elapsedMinutes = Math.floor((Date.now() - missionStartTime) / 60000);
      const recoveryCode = localStorage.getItem(`recovery_${jugador.id}`) || 'â€”';
      const missionTitle = jugador.modo === 'equipo' ? currentTeamMission.titulo : currentMission.titulo;

      document.querySelector('#phase4-completed .mission-card').innerHTML = `
        <h2 style="color:#ffd700; margin-bottom:1rem;">âœ… OperaciÃ³n Completada</h2>
        <p><strong>${missionTitle}</strong></p>
        <p style="font-size:0.95rem; color:#cbd5e1; margin:1rem 0;">
          Tu posiciÃ³n ha sido registrada en el sistema central.
        </p>
        <div style="margin:1.5rem 0; font-size:0.9rem; color:#64b5f7;">
          â±ï¸ Completado en: <strong>${elapsedMinutes} min</strong>
        </div>
        <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:1.5rem;">
          ğŸ”‘ CÃ³digo: <code>${recoveryCode}</code>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="new-mission-btn">ğŸ” Nueva operaciÃ³n</button>
          <button class="btn btn-outline" id="view-progress-btn">ğŸ“Š Ver progreso</button>
        </div>
      `;
      document.getElementById('phase4-completed').style.display = 'block';

      document.getElementById('new-mission-btn').addEventListener('click', () => {
        window.location.href = 'registro.html';
      });

      document.getElementById('view-progress-btn').addEventListener('click', () => {
        window.location.href = 'progreso.html';
      });
    }

    // Event listeners globales
    document.getElementById('narration-toggle')?.addEventListener('click', function() {
      const isOff = localStorage.getItem('lh_narration_off') === '1';
      localStorage.setItem('lh_narration_off', isOff ? '0' : '1');
      this.textContent = isOff ? 'ğŸ”Š' : 'ğŸ”‡';
      showToast(isOff ? 'âœ… NarraciÃ³n activada' : 'ğŸ”‡ NarraciÃ³n desactivada');
    });

    document.getElementById('closeScannerBtn')?.addEventListener('click', stopScanner);
    document.getElementById('manualInputBtn')?.addEventListener('click', () => {
      stopScanner();
      const qrExpected = localStorage.getItem('qrCodeEsperado');
      if (!qrExpected) return showToast("âš ï¸ Acepta una misiÃ³n primero");
      const input = prompt("Ingresa el cÃ³digo QR:", "");
      if (!input) return;
      
      if (jugador.modo === 'equipo') {
        const expected = JSON.parse(qrExpected);
        if (input.trim() === expected.A || input.trim() === expected.B) {
          handleTeamQRScan(input.trim(), expected);
        } else {
          showToast("âŒ CÃ³digo invÃ¡lido.");
        }
      } else {
        // Verificar con Firebase
        (async () => {
          if (input.trim() === qrExpected) {
            const exito = await completarMision(currentMission.id, jugador.zona, jugador.id);
            if (exito) {
              completeMission();
            } else {
              showToast("âŒ Â¡Demasiado tarde! Alguien ya encontrÃ³ el cÃ³digo.");
              setTimeout(showPhase1, 3000);
            }
          } else {
            showToast("âŒ CÃ³digo invÃ¡lido. Â¿EstÃ¡s en el lugar correcto?");
          }
        })();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && scannerActive) stopScanner();
    });

    // Evento para botÃ³n de retorno a la misiÃ³n
    document.getElementById('back-to-mission-btn')?.addEventListener('click', () => {
      // Determinar quÃ© fase mostrar segÃºn el estado actual
      if (document.getElementById('phase4-completed').style.display === 'block') {
        // Ya completÃ³ la misiÃ³n
        document.getElementById('sponsorSection').style.display = 'none';
        document.getElementById('phase4-completed').style.display = 'block';
      } else if (document.getElementById('phase3-pista').style.display === 'block') {
        // EstÃ¡ en la pista final
        document.getElementById('sponsorSection').style.display = 'none';
        document.getElementById('phase3-pista').style.display = 'block';
      } else if (document.getElementById('phase2-mapa').style.display === 'block') {
        // EstÃ¡ en el mapa
        document.getElementById('sponsorSection').style.display = 'none';
        document.getElementById('phase2-mapa').style.display = 'block';
      } else {
        // EstÃ¡ en la consigna inicial
        document.getElementById('sponsorSection').style.display = 'none';
        document.getElementById('phase1-consigna').style.display = 'block';
      }
      
      window.scrollTo(0, 0);
    });

    // Evento para botÃ³n de accesibilidad
    document.getElementById('accessibility-toggle')?.addEventListener('click', toggleAccessibilityMode);

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3500);
    }

    // ========== BANNER DE INSTALACIÃ“N PWA ==========
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    function showInstallBanner() {
      const banner = document.getElementById('pwa-install-banner');
      if (!banner) return;

      const bannerDismissed = localStorage.getItem('pwaBannerDismissed');
      const now = Date.now();
      if (bannerDismissed && (now - parseInt(bannerDismissed)) < 24 * 60 * 60 * 1000) {
        return;
      }

      const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                        || window.navigator.standalone === true;

      if (isStandalone) {
        banner.innerHTML = `
          <button class="close-btn" id="close-install-banner">Ã—</button>
          <p style="margin:0 0 8px;">
            ğŸ¯ Let's Hunt estÃ¡ instalado.
          </p>
          <p style="font-size:0.85rem; margin:0; color:#94a3b8;">
            Â¿Ves esto? Cierra el banner.
          </p>
        `;
        banner.style.display = 'block';
        document.getElementById('close-install-banner').onclick = () => {
          banner.style.display = 'none';
          localStorage.setItem('pwaBannerDismissed', now.toString());
        };
        return;
      }

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      setTimeout(() => {
        banner.style.display = 'block';
        
        if (isIOS) {
          banner.innerHTML = `
            <button class="close-btn" id="close-install-banner">Ã—</button>
            <p style="margin:0 0 8px;">
              ğŸ‘† Toca <strong>Compartir</strong> â†’ <strong>â€œAÃ±adir a pantalla de inicioâ€</strong>
            </p>
          `;
          document.getElementById('close-install-banner').onclick = () => {
            banner.style.display = 'none';
            localStorage.setItem('pwaBannerDismissed', now.toString());
          };
        } else {
          banner.innerHTML = `
            <button class="close-btn" id="close-install-banner">Ã—</button>
            <p style="margin:0 0 8px;">
              ğŸ“¥ Â¿Agregar Let's Hunt a tu pantalla de inicio?
            </p>
            <button id="install-btn" style="
              background:var(--primary); color:white; border:none;
              padding:6px 12px; border-radius:6px; font-weight:bold;
              font-size:0.9rem; margin-top:4px;
            ">Instalar</button>
          `;
          document.getElementById('close-install-banner').onclick = () => {
            banner.style.display = 'none';
            localStorage.setItem('pwaBannerDismissed', now.toString());
          };
          
          document.getElementById('install-btn').onclick = () => {
            if (deferredPrompt) {
              deferredPrompt.prompt();
              deferredPrompt.userChoice.then((choiceResult) => {
                banner.style.display = 'none';
                deferredPrompt = null;
              });
            } else {
              banner.innerHTML = `
                <button class="close-btn" id="close-install-banner">Ã—</button>
                <p style="margin:0 0 8px;">
                  Abre el menÃº del navegador (â‹¯ o â‰¡) y busca <strong>â€œInstalar appâ€</strong>.
                </p>
              `;
              document.getElementById('close-install-banner').onclick = () => {
                banner.style.display = 'none';
                localStorage.setItem('pwaBannerDismissed', now.toString());
              };
            }
          };
        }
      }, 3000);
    }

    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(() => console.log('âœ… SW registrado'))
          .catch(err => console.error('âŒ Error SW:', err));
      });
    }

    // Mostrar banner de instalaciÃ³n
    showInstallBanner();

    // Inicializar app
    window.addEventListener('load', initApp);

    // âœ… CORRECCIÃ“N: BotÃ³n de narraciÃ³n no tapa enlaces en ninguna secciÃ³n
    const narrationToggle = document.getElementById('narration-toggle');
    if (narrationToggle) {
      function adjustNarrationButton() {
        const sections = [
          'sponsorSection',
          'phase1-consigna',
          'phase2-mapa', 
          'phase3-pista',
          'phase4-completed',
          'teamSection'
        ];
        
        let shouldLift = false;
        for (const sectionId of sections) {
          const section = document.getElementById(sectionId);
          if (section && section.style.display !== 'none') {
            shouldLift = true;
            break;
          }
        }
        
        if (shouldLift) {
          narrationToggle.style.bottom = '80px';
        } else {
          narrationToggle.style.bottom = '20px';
        }
      }

      const observer = new MutationObserver(adjustNarrationButton);
      const mainContainer = document.querySelector('main');
      if (mainContainer) {
        observer.observe(mainContainer, { 
          childList: true, 
          subtree: true, 
          attributes: true,
          attributeFilter: ['style']
        });
      }
      adjustNarrationButton();
    }
  </script>
</body>
</html>