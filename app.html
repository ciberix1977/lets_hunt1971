<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Let‚Äôs Hunt ¬∑ App</title>
  <meta name="description" content="Tu cacer√≠a urbana en el Gran Buenos Aires" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Firebase SDK (legacy v8.10.1) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  
  <!-- Librer√≠as externas -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="/manifest.json">

  <meta name="theme-color" content="#000000">

  <!-- Estilos espec√≠ficos para la secci√≥n de sponsors -->
  <style>
  /* Estilos espec√≠ficos para la secci√≥n de sponsors en app.html */
  .sponsor-mission {
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid #ff6b6b;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .sponsor-mission-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .sponsor-mission-title {
    font-weight: bold;
    color: #f8fafc;
    margin: 0;
  }
  .sponsor-badge {
    background: linear-gradient(135deg, #ff6b6b, #ff8e53);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-left: 8px;
  }
  .sponsor-logo {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    padding: 4px;
  }
  </style>
 
</head>
<body>
 <header>
    <div class="header-left">
      <div class="tension-bar" id="tension-bar">‚è≥ <span id="timer">Listo</span></div>
    </div>
    <div class="header-center">
      <img src="logo.webp" alt="Let‚Äôs Hunt" class="app-logo">
    </div>
    <div class="header-right">
      <div class="hunter-id" id="hunterIdDisplay">ID: hunter0000</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- FASE 1: Consigna inicial -->
      <div id="phase1-consigna" class="mission-phase">
        <div class="mission-card"></div>
      </div>

      <!-- FASE 2: Mapa de aproximaci√≥n -->
      <div id="phase2-mapa" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
        <div id="proximity-status" style="text-align:center; margin-top:1rem; color:#64b5f7; font-size:0.9rem;"></div>
      </div>

      <!-- FASE 3: Pista final + QR -->
      <div id="phase3-pista" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
      </div>

      <!-- FASE 4: Misi√≥n completada -->
      <div id="phase4-completed" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
      </div>

      <!-- SECCI√ìN PARA EQUIPOS -->
      <div id="teamSection" class="mission-phase" style="display: none;">
        <div class="mission-card"></div>
        <div id="team-proximity-status" style="text-align:center; margin-top:1rem; color:#64b5f7; font-size:0.9rem;"></div>
      </div>

      <!-- SECCI√ìN DE MISIONES SPONSOR (NUEVO CON IM√ÅGENES) -->
      <div id="sponsorSection" class="mission-phase" style="display: none;">
        <div class="mission-card">
          <h2 style="color:#ff6b6b; margin-bottom:1.2rem;">üéØ Misiones Sponsor</h2>
          <p style="margin-bottom:1.5rem; color:#cbd5e1;">
            Descubr√≠ c√≥mo marcas l√≠deres se integran en la cacer√≠a urbana.
            <br><em>Estas son misiones de demostraci√≥n para sponsors.</em>
          </p>
          
          <div class="sponsor-mission" style="background:rgba(255,107,107,0.1); border:1px solid #ff6b6b; border-radius:12px; padding:16px; margin-bottom:16px;">
            <div class="sponsor-mission-header">
              <div>
                <div class="sponsor-mission-title">üè™ Carrefour ¬∑ Lan√∫s</div>
                <span class="sponsor-badge">DEMO</span>
              </div>
              <img src="sponsors-carrefour.webp" alt="Carrefour" class="sponsor-logo">
            </div>
            <p style="font-size:0.95rem; margin:0 0 12px;">Busca el producto que guarda el sabor del pasado. Su c√≥digo de barras es tu llave.</p>
            <button class="btn btn-outline" style="font-size:0.9rem; padding:6px 12px;">üìç Ver ubicaci√≥n</button>
          </div>

          <div class="sponsor-mission" style="background:rgba(29,161,242,0.1); border:1px solid #1da1f2; border-radius:12px; padding:16px; margin-bottom:16px;">
            <div class="sponsor-mission-header">
              <div>
                <div class="sponsor-mission-title">üëü Nike ¬∑ CABA</div>
                <span class="sponsor-badge">DEMO</span>
              </div>
               <img src="sponsors-nike.webp" alt="Nike" class="sponsor-logo">
            </div>
            <p style="font-size:0.95rem; margin:0 0 12px;">La huella del cazador est√° en la suela del maniqu√≠. Escan√©ala antes de que desaparezca.</p>
            <button class="btn btn-outline" style="font-size:0.9rem; padding:6px 12px;">üìç Ver ubicaci√≥n</button>
          </div>

          <div class="sponsor-mission" style="background:rgba(255,200,0,0.1); border:1px solid #ffc800; border-radius:12px; padding:16px; margin-bottom:16px;">
            <div class="sponsor-mission-header">
              <div>
                <div class="sponsor-mission-title">‚õΩ YPF ¬∑ Avellaneda</div>
                <span class="sponsor-badge">DEMO</span>
              </div>
              <img src="sponsors-ypf.webp" alt="YPF" class="sponsor-logo">
            </div>
            <p style="font-size:0.95rem; margin:0 0 12px;">El surtidor 3 tiene memoria. Busca el n√∫mero que nadie ve.</p>
            <button class="btn btn-outline" style="font-size:0.9rem; padding:6px 12px;">üìç Ver ubicaci√≥n</button>
          </div>

          <div style="margin-top:24px; padding-top:20px; border-top:1px solid var(--surface-border);">
            <h3 style="margin-bottom:12px;">¬øQuer√©s que tu marca est√© aqu√≠?</h3>
            <p style="font-size:0.9rem; color:#94a3b8; margin-bottom:16px;">
              Ofrecemos integraciones org√°nicas, no intrusivas, con recompensas reales para hunters.
            </p>
            <a href="mailto:contacto@letshunt.ar?subject=Sponsor%20Let%E2%80%99s%20Hunt" class="btn btn-primary" style="display:inline-block;">
              üì© Contactar para patrocinar
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de invitaci√≥n (equipo) -->
  <div id="inviteModal" class="modal-overlay">
    <div class="modal-content">
      <h3>üë• Invitar a tu equipo</h3>
      <p>Compart√≠ este c√≥digo para que otros se unan:</p>
      <div id="codigoInvitacion">CARGANDO...</div>
      <div class="modal-actions">
        <button id="copyCodeBtn" class="btn btn-outline">üìã Copiar c√≥digo</button>
        <button id="shareWaBtn" class="btn btn-primary">üí¨ WhatsApp</button>
      </div>
      <button id="closeModalBtn" class="modal-close">Cerrar</button>
    </div>
  </div>

  <!-- Esc√°ner QR -->
  <div id="scannerOverlay" class="modal-overlay">
    <div class="scanner-container">
      <h3>üîç Escanea el C√≥digo QR</h3>
      <video id="scannerVideo" autoplay playsinline></video>
      <canvas id="scannerCanvas" style="display: none;"></canvas>
      
      <div class="scanner-frame">
        <div class="scanner-corner tl"></div>
        <div class="scanner-corner tr"></div>
        <div class="scanner-corner bl"></div>
        <div class="scanner-corner br"></div>
      </div>

      <div class="scanner-actions">
        <button id="closeScannerBtn" class="btn btn-outline">‚ùå Cancelar</button>
        <button id="manualInputBtn" class="btn btn-primary">‚å®Ô∏è Ingresar manualmente</button>
      </div>
    </div>
  </div>

  <!-- NAVEGACI√ìN M√ìVIL (con nueva opci√≥n) -->
  <nav class="mobile-nav">
    <a href="progreso.html#radar"><i>üì°</i>Se√±al</a>
    <a href="#misiones"><i>üéØ</i>Misiones</a>
    <a href="#scan" id="nav-scan"><i>üîç</i>Escanear</a>
    <a href="progreso.html"><i>üìä</i>Progreso</a>
    <a href="#sponsors" id="nav-sponsors"><i>üè¢</i>Sponsors</a>
  </nav>

  <!-- CONTROLES GLOBALES -->
  <button id="narration-toggle" title="Activar/Desactivar narraci√≥n">üîä</button>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Contenedor del banner de instalaci√≥n -->
  <div id="pwa-install-banner"></div>

  <!-- L√ìGICA PRINCIPAL -->
  <script>
    // ========== FIREBASE ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDvMo1LPD_FGk-Ahju8oN7WEn9w0B5bqUE",
      authDomain: "let-s-hunt.firebaseapp.com",
      databaseURL: "https://let-s-hunt-default-rtdb.firebaseio.com",
      projectId: "let-s-hunt",
      storageBucket: "let-s-hunt.firebasestorage.app",
      messagingSenderId: "787017812046",
      appId: "1:787017812046:web:da098b2361df4dda995b1f",
      measurementId: "G-07SR9WR8NV"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const analytics = firebase.analytics();

    // ========== DATOS DIN√ÅMICOS ==========
    let misionesSolitario = [];
    let misionesEquipo = [];
    let currentMission = null;
    let missionStartTime = null;
    let deferredPrompt;

    // ========== INICIALIZACI√ìN ==========
    async function initApp() {
      try {
        const [solitarioRes, equipoRes] = await Promise.all([
          fetch('misiones-solitario.json'),
          fetch('misiones-equipo-local.json')
        ]);
        if (!solitarioRes.ok) throw new Error(`Error ${solitarioRes.status}: misiones-solitario.json`);
        if (!equipoRes.ok) throw new Error(`Error ${equipoRes.status}: misiones-equipo-local.json`);
        misionesSolitario = await solitarioRes.json();
        misionesEquipo = await equipoRes.json();
      } catch (err) {
        console.error("‚ö†Ô∏è Error cr√≠tico:", err);
        showToast("‚ö†Ô∏è Error al cargar misiones. Verifica los archivos JSON.");
        misionesSolitario = [
          { id: 1, zona: "CABA", titulo: "Misi√≥n de prueba", ubicacion_mapa: "Plaza de Mayo", pista_al_llegar: "Busca la pista final.", coordenadas: { lat: -34.6037, lng: -58.3816 } }
        ];
      }
      setupJugador();
    }

    // ========== VERIFICACI√ìN DE MISI√ìN EN TIEMPO REAL ==========
    async function isMisionDisponible(misionId, zona) {
      try {
        const misionRef = db.ref(`misiones/${misionId}-${zona}`);
        const snapshot = await misionRef.once('value');
        
        if (!snapshot.exists()) {
          return true; // Disponible si no existe
        }
        
        const data = snapshot.val();
        return data.estado !== 'completada';
      } catch (err) {
        console.error("Error en Firebase:", err);
        return true; // Fallback seguro
      }
    }

    // ========== COMPLETAR MISI√ìN CON SINCRONIZACI√ìN EN TIEMPO REAL ==========
    async function completarMision(misionId, zona, hunterId) {
      try {
        const misionRef = db.ref(`misiones/${misionId}-${zona}`);
        
        // Usar transacci√≥n at√≥mica
        const result = await misionRef.transaction((currentData) => {
          if (currentData === null) {
            // Primero en completar
            return {
              estado: 'completada',
              hunter_ganador: hunterId,
              timestamp: Date.now(),
              version: 1
            };
          }
          
          if (currentData.estado === 'completada') {
            // Ya fue completada por otro jugador
            return; // No modificar los datos
          }
          
          // Caso te√≥rico: estado inv√°lido
          return currentData;
        });
        
        // Verificar si la transacci√≥n fue exitosa y este jugador gan√≥
        if (result.committed && result.snapshot.val()?.hunter_ganador === hunterId) {
          return true; // Este jugador gan√≥
        }
        
        return false; // Otro jugador gan√≥ primero
        
      } catch (err) {
        console.error("Error en transacci√≥n de misi√≥n:", err);
        // En caso de error, asumir que fall√≥ (no bloquear al jugador)
        return true;
      }
    }

    // Funci√≥n para ocultar todas las fases
    function hideAllPhases() {
      document.getElementById('phase1-consigna').style.display = 'none';
      document.getElementById('phase2-mapa').style.display = 'none';
      document.getElementById('phase3-pista').style.display = 'none';
      document.getElementById('phase4-completed').style.display = 'none';
      document.getElementById('teamSection').style.display = 'none';
      document.getElementById('sponsorSection').style.display = 'none';
    }

    // Manejar navegaci√≥n a sponsors
    document.getElementById('nav-sponsors')?.addEventListener('click', (e) => {
      e.preventDefault();
      hideAllPhases();
      document.getElementById('sponsorSection').style.display = 'block';
      window.scrollTo(0, 0);
    });

    // ========== CONFIGURACI√ìN DEL JUGADOR ==========
    let jugador;
    let firebaseUser = null;

    function setupJugador() {
      const urlParams = new URLSearchParams(window.location.search);
      let hunterId = urlParams.get('id') || localStorage.getItem('currentHunterId');

      // Iniciar sesi√≥n an√≥nima
      auth.signInAnonymously().catch((error) => {
        console.error("Error al iniciar sesi√≥n an√≥nima:", error);
      });

      auth.onAuthStateChanged((user) => {
        if (user) {
          firebaseUser = user;
          localStorage.setItem('firebaseUid', user.uid);
          
          // Generar hunterId basado en UID
          hunterId = `hunter_${user.uid.substring(0, 8)}`;
          localStorage.setItem('currentHunterId', hunterId);
          
          _continueSetupJugador(hunterId);
        } else {
          _continueSetupJugador(hunterId);
        }
      });
    }

    function _continueSetupJugador(hunterId) {
      if (!hunterId) {
        const nextId = parseInt(localStorage.getItem('lastHunterId') || '0') + 1;
        hunterId = `hunter_${String(nextId).padStart(4, '0')}`;
        localStorage.setItem('lastHunterId', nextId);
        
        const ciudadFromURL = decodeURIComponent((new URLSearchParams(window.location.search).get('zona') || 'CABA').replace(/\+/g, ' ')).trim();
        jugador = {
          id: hunterId,
          nombre: 'Jugador de Prueba',
          telefono: '+5491112345678',
          zona: ciudadFromURL,
          modo: 'individual'
        };
        localStorage.setItem(`jugador_${hunterId}`, JSON.stringify(jugador));
        localStorage.setItem('currentHunterId', hunterId);
      } else {
        // Manejo seguro de localStorage
        let storedJugador;
        try {
          storedJugador = JSON.parse(localStorage.getItem(`jugador_${hunterId}`));
        } catch (e) {
          console.warn("Datos corruptos en localStorage. Reiniciando jugador.");
          storedJugador = null;
        }

        jugador = storedJugador || {
          id: hunterId,
          zona: 'CABA',
          modo: 'individual'
        };

        const ciudadFromURL = decodeURIComponent((new URLSearchParams(window.location.search).get('zona') || '').replace(/\+/g, ' ')).trim();
        if (ciudadFromURL) {
          const zonaNormalizada = ciudadFromURL.normalize('NFC');
          if (getMisionesByZona(zonaNormalizada, 'solitario').length > 0) {
            jugador.zona = zonaNormalizada;
          }
        }

        localStorage.setItem(`jugador_${hunterId}`, JSON.stringify(jugador));
        localStorage.setItem('currentHunterId', hunterId);
      }

      document.getElementById('hunterIdDisplay').textContent = 
        jugador.modo === 'equipo' ? `üë• ${jugador.equipo || hunterId}` : `ID: ${hunterId}`;

      // Mostrar la misi√≥n correspondiente
      if (jugador.modo === 'equipo') {
        showTeamMission();
      } else {
        showPhase1();
      }
    }

    // ========== UTILIDADES DE MISI√ìN ==========
    function getMisionesByZona(zona, tipo = 'solitario') {
      const lista = tipo === 'equipo' ? misionesEquipo : misionesSolitario;
      
      const zonaNormalizada = (zona || '').trim().toLowerCase();
      
      const barriosCABA = [
        'san telmo', 'la boca', 'recoleta', 'microcentro', 'palermo',
        'congreso', 'almagro', 'retiro', 'balvanera', 'villa crespo',
        'belgrano', 'barracas', 'flores', 'villa urquiza', 'puerto madero',
        'san crist√≥bal'
      ];
      
      return lista.filter(m => {
        const misionZona = (m.zona || '').trim().toLowerCase();
        
        if (misionZona === zonaNormalizada) {
          return true;
        }
        
        if (zonaNormalizada === 'caba' && barriosCABA.includes(misionZona)) {
          return true;
        }
        
        if (barriosCABA.includes(zonaNormalizada) && barriosCABA.includes(misionZona)) {
          return true;
        }
        
        return false;
      });
    }

    function selectRandomMission(zona, tipo = 'solitario') {
      const misiones = getMisionesByZona(zona, tipo);
      if (misiones.length === 0) {
        return getMisionesByZona('CABA', tipo)[0] || misionesSolitario[0];
      }
      return misiones[Math.floor(Math.random() * misiones.length)];
    }

    // ========== FLUJO INDIVIDUAL ==========
    async function showPhase1() {
      currentMission = selectRandomMission(jugador.zona, 'solitario');
      
      // Registrar evento de Analytics
      analytics.logEvent('mision_aceptada', {
        zona: jugador.zona,
        tipo: 'solitario',
        hunter_id: jugador.id
      });
      
      // Verificar disponibilidad en tiempo real
      const disponible = await isMisionDisponible(currentMission.id, jugador.zona);
      
      if (!disponible) {
        showToast("‚ö†Ô∏è Alguien ya complet√≥ esta misi√≥n. Buscando otra...");
        setTimeout(showPhase1, 2000);
        return;
      }

      document.querySelector('#phase1-consigna .mission-card').innerHTML = `
        <div class="mission-title">
          <span class="icon">ü¶Å</span>
          ${currentMission.titulo}
        </div>
        <div class="tension-bar" style="margin: 1rem 0; background: rgba(255,69,58,0.15);">
          ‚è≥ Listo para cazar
        </div>
        <p class="pista">${currentMission.descripcion_narrativa || currentMission.pista_al_llegar}</p>
        <button class="btn btn-primary" id="start-mission-btn">‚úÖ Aceptar y comenzar</button>
      `;
      document.getElementById('phase1-consigna').style.display = 'block';
      
      document.getElementById('start-mission-btn').addEventListener('click', () => {
        missionStartTime = Date.now();
        startTimer();
        guardarProgreso(currentMission.id);
        showPhase2();
      });
    }

    function showPhase2() {
      document.getElementById('phase1-consigna').style.display = 'none';
      document.querySelector('#phase2-mapa .mission-card').innerHTML = `
        <h3>üìç Ac√©rcate al objetivo</h3>
        <p style="margin: 1rem 0; color:#cbd5e1;">${currentMission.ubicacion_mapa}</p>
        <div id="mapApprox" style="height: 300px; border-radius:12px; margin:1rem 0;"></div>
        <p id="proximity-instructions" style="font-size:0.9rem; color:#94a3b8;">Esperando tu ubicaci√≥n...</p>
      `;
      document.getElementById('phase2-mapa').style.display = 'block';
      loadApproxMap(currentMission.coordenadas.lat, currentMission.coordenadas.lng);
      startProximityCheck(currentMission.coordenadas.lat, currentMission.coordenadas.lng);
    }

    function showPhase3() {
      document.getElementById('phase2-mapa').style.display = 'none';
      const recoveryCode = generarRecoveryCode();
      localStorage.setItem(`recovery_${jugador.id}`, recoveryCode);
      
      document.querySelector('#phase3-pista .mission-card').innerHTML = `
        <h3>üîç Pista final</h3>
        <p class="pista">${currentMission.pista_al_llegar}</p>
        <div class="actions">
          <button class="btn btn-primary" id="scan-btn">üîç Escanear QR</button>
        </div>
        <div style="margin-top:1.2rem; font-size:0.9rem;">
          üîë C√≥digo de recuperaci√≥n: <code>${recoveryCode}</code>
        </div>
      `;
      document.getElementById('phase3-pista').style.display = 'block';
      document.getElementById('scan-btn').addEventListener('click', openQRScanner);
      playNarration(`Cazador ${jugador.id.replace('hunter_', '')}. Est√°s en la zona. La pista final ha sido revelada.`);
    }

    // ========== FLUJO EQUIPO ==========
    let currentTeamMission = null;
    async function showTeamMission() {
      document.body.classList.add('modo-equipo');
      currentTeamMission = selectRandomMission(jugador.zona, 'equipo');
      const recoveryCode = generarRecoveryCode();
      localStorage.setItem(`recovery_${jugador.id}`, recoveryCode);
      
      document.querySelector('#teamSection .mission-card').innerHTML = `
        <div class="mission-title">
          <span class="icon">üëÅÔ∏è</span>
          ${currentTeamMission.titulo}
          <span class="status active nivel-N2">ACTIVA ‚Ä¢ N2</span>
        </div>
        <p class="pista">${currentTeamMission.descripcion_narrativa}</p>
        <div class="actions">
          <button class="btn btn-primary" id="accept-mission-btn">‚úÖ Aceptar misi√≥n</button>
          <button class="btn btn-outline" id="scan-btn-team">üîç Escanear QR</button>
        </div>
        <div style="margin-top:1.2rem; font-size:0.9rem;">
          üîë C√≥digo de recuperaci√≥n: <code>${recoveryCode}</code>
        </div>
      `;
      document.getElementById('teamSection').style.display = 'block';

      document.getElementById('accept-mission-btn').addEventListener('click', () => {
        missionStartTime = Date.now();
        startTimer();
        guardarProgreso(currentTeamMission.id);
        showToast("‚úÖ Misi√≥n aceptada. ¬°Buena cacer√≠a!");
        startTeamProximityCheck();
      });

      document.getElementById('scan-btn-team').addEventListener('click', openQRScanner);
    }

    function startTeamProximityCheck() {
      const coordsA = currentTeamMission.qr_cercanos[0].coordenadas;
      loadApproxMap(coordsA.lat, coordsA.lng);
      document.getElementById('team-proximity-status').textContent = "üìç Esperando ubicaci√≥n...";
      
      if (navigator.geolocation) {
        const watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            const distA = calculateDistance(userLat, userLng, coordsA.lat, coordsA.lng);
            const coordsB = currentTeamMission.qr_cercanos[1]?.coordenadas;
            let statusText = `Est√°s a ${distA.toFixed(0)} m del QR A`;
            if (coordsB) {
              const distB = calculateDistance(userLat, userLng, coordsB.lat, coordsB.lng);
              statusText += ` | ${distB.toFixed(0)} m del QR B`;
            }
            document.getElementById('team-proximity-status').textContent = statusText;
          },
          (err) => {
            document.getElementById('team-proximity-status').textContent = "‚ö†Ô∏è Ubicaci√≥n desactivada";
          },
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
        );
      }
    }

    // ========== VALIDACI√ìN DE PROXIMIDAD REAL ==========
    let proximityWatchId = null;
    function startProximityCheck(targetLat, targetLng) {
      if (navigator.geolocation) {
        document.getElementById('proximity-instructions').textContent = "Verificando tu ubicaci√≥n...";
        proximityWatchId = navigator.geolocation.watchPosition(
          (pos) => {
            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            const distance = calculateDistance(userLat, userLng, targetLat, targetLng);
            
            const statusEl = document.getElementById('proximity-status');
            if (distance <= 50) {
              statusEl.innerHTML = "‚úÖ ¬°Est√°s en la zona! Puedes acceder a la pista final.";
              statusEl.style.color = "#4ade80";
              if (!document.getElementById('unlock-phase3-btn')) {
                const btn = document.createElement('button');
                btn.id = 'unlock-phase3-btn';
                btn.className = 'btn btn-primary';
                btn.textContent = 'üîì Acceder a la pista final';
                btn.onclick = showPhase3;
                document.querySelector('#phase2-mapa .mission-card').appendChild(btn);
              }
            } else {
              statusEl.innerHTML = `üìç A ${Math.round(distance)} metros del objetivo. Ac√©rcate m√°s.`;
              statusEl.style.color = "#64b5f7";
              const unlockBtn = document.getElementById('unlock-phase3-btn');
              if (unlockBtn) unlockBtn.remove();
            }
          },
          (err) => {
            document.getElementById('proximity-status').textContent = "‚ö†Ô∏è No se pudo obtener tu ubicaci√≥n. Activa GPS.";
          },
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
        );
      } else {
        document.getElementById('proximity-status').textContent = "‚ö†Ô∏è Tu navegador no soporta geolocalizaci√≥n.";
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI/180;
      const œÜ2 = lat2 * Math.PI/180;
      const ŒîœÜ = (lat2-lat1) * Math.PI/180;
      const ŒîŒª = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    // ========== MAPA ==========
    function loadApproxMap(lat, lng) {
      if (!window.L) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(link);
        
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        script.onload = () => initApproxMap(lat, lng);
        document.head.appendChild(script);
      } else {
        initApproxMap(lat, lng);
      }
    }

    function initApproxMap(lat, lng) {
      const map = L.map('mapApprox').setView([lat, lng], 18.5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      
      L.circle([lat, lng], {
        color: '#ff6b6b',
        fillColor: '#ff6b6b',
        fillOpacity: 0.15,
        radius: 50
      }).addTo(map);

      L.marker([lat, lng]).addTo(map).bindPopup(`<strong>Objetivo</strong><br>Zona de 50m`);
    }

    // ========== TEMPORIZADOR ==========
    function startTimer() {
      document.getElementById('timer').textContent = "90:00";
      let timeLeft = 90 * 60;
      const timerEl = document.getElementById('timer');
      const interval = setInterval(() => {
        if (timeLeft <= 0) {
          timerEl.textContent = "‚è∞ Caducada";
          clearInterval(interval);
          return;
        }
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        timeLeft--;
      }, 1000);
    }

    // ========== ESC√ÅNER QR ==========
    let scannerActive = false;
    let stream = null;

    async function openQRScanner() {
      let qrExpected;
      if (jugador.modo === 'equipo' && currentTeamMission) {
        qrExpected = {
          A: `LH-${currentTeamMission.id}-A-${jugador.id.split('_')[1]}`,
          B: `LH-${currentTeamMission.id}-B-${jugador.id.split('_')[1]}`
        };
        localStorage.setItem('qrCodeEsperado', JSON.stringify(qrExpected));
      } else {
        qrExpected = `LH-${currentMission.id}-${jugador.id.split('_')[1]}`;
        localStorage.setItem('qrCodeEsperado', qrExpected);
      }
      
      const overlay = document.getElementById('scannerOverlay');
      const video = document.getElementById('scannerVideo');
      const canvas = document.getElementById('scannerCanvas');
      
      try {
        const constraints = { video: { facingMode: { ideal: "environment" } } };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        };
        
        overlay.style.display = 'block';
        scannerActive = true;
        
        const scanInterval = setInterval(async () => {
          if (!scannerActive || !video.videoWidth) return;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height, { inversionAttempts: "dontInvert" });
          
          if (code && code.data) {
            clearInterval(scanInterval);
            stopScanner();
            
            const codigoEscaneado = code.data.trim();
            let exito = false;
            
            if (jugador.modo === 'equipo') {
              // Para equipos, verificar QR individual
              exito = true; // Simplificado para equipos
              handleTeamQRScan(codigoEscaneado, qrExpected);
            } else {
              // Para individuales, verificar con transacci√≥n at√≥mica
              if (codigoEscaneado === qrExpected) {
                exito = await completarMision(currentMission.id, jugador.zona, jugador.id);
              }
            }
            
            if (!exito && jugador.modo !== 'equipo') {
              analytics.logEvent('qr_escaneo_fallido', {
                zona: jugador.zona,
                hunter_id: jugador.id
              });
              showToast("‚ùå ¬°Demasiado tarde! Alguien ya encontr√≥ el c√≥digo.");
              setTimeout(showPhase1, 3000);
              return;
            }
            
            if (exito || jugador.modo === 'equipo') {
              completeMission();
            } else {
              showToast("‚ùå C√≥digo incorrecto. ¬øEst√°s en el lugar correcto?");
              setTimeout(() => scannerActive && (overlay.style.display = 'block'), 1500);
            }
          }
        }, 300);
      } catch (err) {
        stopScanner();
        showToast("‚ö†Ô∏è Error de c√°mara. Usa ingreso manual.");
      }
    }

    function handleTeamQRScan(scannedCode, expectedCodes) {
      const key = `teamScan_${jugador.id}_${currentTeamMission.id}`;
      let scans = JSON.parse(localStorage.getItem(key) || '{}');
      
      if (scannedCode === expectedCodes.A) {
        scans.A = Date.now();
        localStorage.setItem(key, JSON.stringify(scans));
        showToast("‚úÖ QR A escaneado. ¬°Ahora busca el QR B!");
      } else if (scannedCode === expectedCodes.B) {
        scans.B = Date.now();
        localStorage.setItem(key, JSON.stringify(scans));
        showToast("‚úÖ QR B escaneado. ¬°Ahora busca el QR A!");
      }
      
      if (scans.A && scans.B) {
        const diff = Math.abs(scans.B - scans.A);
        if (diff <= 15000) {
          completeMission();
        } else {
          showToast("‚ùå Los escaneos no fueron sincronizados. Int√©ntalo de nuevo.");
        }
      }
    }

    function completeMission() {
      const misionId = jugador.modo === 'equipo' ? currentTeamMission.id : currentMission.id;
      guardarProgreso(null, `${misionId}_desafio_1`);
      
      // Registrar evento de Analytics
      analytics.logEvent('mision_completada', {
        zona: jugador.zona,
        tipo: jugador.modo,
        hunter_id: jugador.id,
        tiempo_min: Math.floor((Date.now() - missionStartTime) / 60000)
      });
      
      playNarration(`Confirmado. Has completado la misi√≥n. El ranking se actualiza ahora.`);
      showToast(`‚úÖ ¬°C√≥digo verificado!\nüî• ¬°Cazador ${jugador.id} ha completado la misi√≥n!`);
      showMissionCompleted();
    }

    function stopScanner() {
      scannerActive = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      document.getElementById('scannerOverlay').style.display = 'none';
    }

    // ========== UTILIDADES COMPARTIDAS ==========
    function generarRecoveryCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = 'LH';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function guardarProgreso(misionId = null, desafioId = null) {
      const key = `progreso_${jugador.id}`;
      let data = JSON.parse(localStorage.getItem(key) || '{}');
      if (!data.misiones) data.misiones = 0;
      if (!data.desafios) data.desafios = 0;
      if (!data.zona) data.zona = jugador.zona;
      
      if (misionId) {
        const misionesKey = `misiones_aceptadas_${jugador.id}`;
        let misiones = JSON.parse(localStorage.getItem(misionesKey) || '[]');
        if (!misiones.includes(misionId)) {
          misiones.push(misionId);
          localStorage.setItem(misionesKey, JSON.stringify(misiones));
          data.misiones = misiones.length;
        }
      }
      if (desafioId) {
        const desafiosKey = `desafios_completados_${jugador.id}`;
        let desafios = JSON.parse(localStorage.getItem(desafiosKey) || '[]');
        if (!desafios.includes(desafioId)) {
          desafios.push(desafioId);
          localStorage.setItem(desafiosKey, JSON.stringify(desafios));
          data.desafios = desafios.length;
        }
      }
      data.zona = jugador.zona;
      data.lastUpdate = Date.now();
      localStorage.setItem(key, JSON.stringify(data));
    }

    function playNarration(text) {
      if (localStorage.getItem('lh_narration_off') === '1') return;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.62;
      u.pitch = 0.4;
      u.volume = 0.95;
      const loadVoice = () => {
        const voices = speechSynthesis.getVoices();
        const voice = voices.find(v => 
          v.lang.includes('es') && 
          (v.name.includes('Male') || v.name === 'Diego' || v.name === 'Juan')
        ) || voices.find(v => v.lang.includes('es')) || null;
        if (voice) u.voice = voice;
      };
      loadVoice();
      speechSynthesis.addEventListener('voiceschanged', loadVoice, { once: true });
      u.onstart = () => {
        if (window.AudioContext) {
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const delay = ctx.createDelay(1.5);
            delay.delayTime.value = 0.7;
            const feedback = ctx.createGain();
            feedback.gain.value = 0.25;
            delay.connect(feedback);
            feedback.connect(delay);
            setTimeout(() => ctx.close(), 4000);
          } catch (e) {}
        }
      };
      speechSynthesis.speak(u);
    }

    function showMissionCompleted() {
      document.getElementById('phase1-consigna').style.display = 'none';
      document.getElementById('phase2-mapa').style.display = 'none';
      document.getElementById('phase3-pista').style.display = 'none';
      document.getElementById('teamSection').style.display = 'none';

      const elapsedMinutes = Math.floor((Date.now() - missionStartTime) / 60000);
      const recoveryCode = localStorage.getItem(`recovery_${jugador.id}`) || '‚Äî';
      const missionTitle = jugador.modo === 'equipo' ? currentTeamMission.titulo : currentMission.titulo;

      document.querySelector('#phase4-completed .mission-card').innerHTML = `
        <h2 style="color:#ffd700; margin-bottom:1rem;">‚úÖ Operaci√≥n Completada</h2>
        <p><strong>${missionTitle}</strong></p>
        <p style="font-size:0.95rem; color:#cbd5e1; margin:1rem 0;">
          Tu posici√≥n ha sido registrada en el sistema central.
        </p>
        <div style="margin:1.5rem 0; font-size:0.9rem; color:#64b5f7;">
          ‚è±Ô∏è Completado en: <strong>${elapsedMinutes} min</strong>
        </div>
        <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:1.5rem;">
          üîë C√≥digo: <code>${recoveryCode}</code>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="new-mission-btn">üîÅ Nueva operaci√≥n</button>
          <button class="btn btn-outline" id="view-progress-btn">üìä Ver progreso</button>
        </div>
      `;
      document.getElementById('phase4-completed').style.display = 'block';

      document.getElementById('new-mission-btn').addEventListener('click', () => {
        window.location.href = 'registro.html';
      });

      document.getElementById('view-progress-btn').addEventListener('click', () => {
        window.location.href = 'progreso.html';
      });
    }

    // Event listeners globales
    document.getElementById('narration-toggle')?.addEventListener('click', function() {
      const isOff = localStorage.getItem('lh_narration_off') === '1';
      localStorage.setItem('lh_narration_off', isOff ? '0' : '1');
      this.textContent = isOff ? 'üîä' : 'üîá';
      showToast(isOff ? '‚úÖ Narraci√≥n activada' : 'üîá Narraci√≥n desactivada');
    });

    document.getElementById('closeScannerBtn')?.addEventListener('click', stopScanner);
    document.getElementById('manualInputBtn')?.addEventListener('click', () => {
      stopScanner();
      const qrExpected = localStorage.getItem('qrCodeEsperado');
      if (!qrExpected) return showToast("‚ö†Ô∏è Acepta una misi√≥n primero");
      const input = prompt("Ingresa el c√≥digo QR:", "");
      if (!input) return;
      
      if (jugador.modo === 'equipo') {
        const expected = JSON.parse(qrExpected);
        if (input.trim() === expected.A || input.trim() === expected.B) {
          handleTeamQRScan(input.trim(), expected);
        } else {
          showToast("‚ùå C√≥digo inv√°lido.");
        }
      } else {
        // Verificar con transacci√≥n at√≥mica
        (async () => {
          if (input.trim() === qrExpected) {
            const exito = await completarMision(currentMission.id, jugador.zona, jugador.id);
            if (exito) {
              completeMission();
            } else {
              showToast("‚ùå ¬°Demasiado tarde! Alguien ya encontr√≥ el c√≥digo.");
              setTimeout(showPhase1, 3000);
            }
          } else {
            showToast("‚ùå C√≥digo inv√°lido. ¬øEst√°s en el lugar correcto?");
          }
        })();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && scannerActive) stopScanner();
    });

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3500);
    }

    // ========== BANNER DE INSTALACI√ìN PWA ==========
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    function showInstallBanner() {
      const banner = document.getElementById('pwa-install-banner');
      if (!banner) return;

      const bannerDismissed = localStorage.getItem('pwaBannerDismissed');
      const now = Date.now();
      if (bannerDismissed && (now - parseInt(bannerDismissed)) < 24 * 60 * 60 * 1000) {
        return;
      }

      const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                        || window.navigator.standalone === true;

      if (isStandalone) {
        banner.innerHTML = `
          <button class="close-btn" id="close-install-banner">√ó</button>
          <p style="margin:0 0 8px;">
            üéØ Let's Hunt est√° instalado.
          </p>
          <p style="font-size:0.85rem; margin:0; color:#94a3b8;">
            ¬øVes esto? Cierra el banner.
          </p>
        `;
        banner.style.display = 'block';
        document.getElementById('close-install-banner').onclick = () => {
          banner.style.display = 'none';
          localStorage.setItem('pwaBannerDismissed', now.toString());
        };
        return;
      }

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      setTimeout(() => {
        banner.style.display = 'block';
        
        if (isIOS) {
          banner.innerHTML = `
            <button class="close-btn" id="close-install-banner">√ó</button>
            <p style="margin:0 0 8px;">
              üëÜ Toca <strong>Compartir</strong> ‚Üí <strong>‚ÄúA√±adir a pantalla de inicio‚Äù</strong>
            </p>
          `;
          document.getElementById('close-install-banner').onclick = () => {
            banner.style.display = 'none';
            localStorage.setItem('pwaBannerDismissed', now.toString());
          };
        } else {
          banner.innerHTML = `
            <button class="close-btn" id="close-install-banner">√ó</button>
            <p style="margin:0 0 8px;">
              üì• ¬øAgregar Let's Hunt a tu pantalla de inicio?
            </p>
            <button id="install-btn" style="
              background:var(--primary); color:white; border:none;
              padding:6px 12px; border-radius:6px; font-weight:bold;
              font-size:0.9rem; margin-top:4px;
            ">Instalar</button>
          `;
          document.getElementById('close-install-banner').onclick = () => {
            banner.style.display = 'none';
            localStorage.setItem('pwaBannerDismissed', now.toString());
          };
          
          document.getElementById('install-btn').onclick = () => {
            if (deferredPrompt) {
              deferredPrompt.prompt();
              deferredPrompt.userChoice.then((choiceResult) => {
                banner.style.display = 'none';
                deferredPrompt = null;
              });
            } else {
              banner.innerHTML = `
                <button class="close-btn" id="close-install-banner">√ó</button>
                <p style="margin:0 0 8px;">
                  Abre el men√∫ del navegador (‚ãØ o ‚â°) y busca <strong>‚ÄúInstalar app‚Äù</strong>.
                </p>
              `;
              document.getElementById('close-install-banner').onclick = () => {
                banner.style.display = 'none';
                localStorage.setItem('pwaBannerDismissed', now.toString());
              };
            }
          };
        }
      }, 3000);
    }

    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(() => console.log('‚úÖ SW registrado'))
          .catch(err => console.error('‚ùå Error SW:', err));
      });
    }

    // Mostrar banner de instalaci√≥n
    showInstallBanner();

    // Inicializar app
    window.addEventListener('load', initApp);

    // ‚úÖ CORRECCI√ìN: Bot√≥n de narraci√≥n no tapa enlaces en ninguna secci√≥n
    const narrationToggle = document.getElementById('narration-toggle');
    if (narrationToggle) {
      function adjustNarrationButton() {
        const sections = [
          'sponsorSection',
          'phase1-consigna',
          'phase2-mapa', 
          'phase3-pista',
          'phase4-completed',
          'teamSection'
        ];
        
        let shouldLift = false;
        for (const sectionId of sections) {
          const section = document.getElementById(sectionId);
          if (section && section.style.display !== 'none') {
            shouldLift = true;
            break;
          }
        }
        
        if (shouldLift) {
          narrationToggle.style.bottom = '80px';
        } else {
          narrationToggle.style.bottom = '20px';
        }
      }

      const observer = new MutationObserver(adjustNarrationButton);
      const mainContainer = document.querySelector('main');
      if (mainContainer) {
        observer.observe(mainContainer, { 
          childList: true, 
          subtree: true, 
          attributes: true,
          attributeFilter: ['style']
        });
      }
      adjustNarrationButton();
    }
  </script>
</body>
</html>