<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vigilante ‚Äî Let's Hunt</title>
  
  <!-- Firebase SDK (legacy v8.10.1) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0c0f1a;
      color: #e0d6c5;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      color: #c1a37a;
      margin: 20px 0;
      text-shadow: 0 0 8px rgba(150, 100, 60, 0.4);
    }
    .player-card {
      background: rgba(20, 25, 45, 0.7);
      border: 1px solid #4a3a2a;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      display: flex;
      flex-direction: column;
    }
    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .player-name {
      font-size: 1.4em;
      font-weight: bold;
      color: #ffb347;
    }
    .mission-id {
      background: #2a3a5a;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .countdown {
      font-size: 1.8em;
      font-weight: bold;
      color: #ffcc80;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
    }
    .video-container {
      width: 100%;
      height: 300px;
      background: #000;
      border-radius: 8px;
      margin: 15px 0;
      overflow: hidden;
      display: none;
    }
    .video-placeholder {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-style: italic;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 18px;
      font-size: 0.95em;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-watch {
      background: #2c263a;
      color: #e0d6c5;
      border: 1px solid #8a6ba8;
    }
    .btn-success {
      background: #1e3a1e;
      color: white;
      border: 1px solid #4caf50;
    }
    .btn-danger {
      background: #3a1e1e;
      color: white;
      border: 1px solid #f44336;
    }
    .btn-audio {
      background: #3a2a4a;
      color: #d4c0f0;
      border: 1px solid #9c7ae0;
    }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .status {
      margin-top: 10px;
      font-size: 0.9em;
      color: #a89a85;
    }
    .instructions {
      background: rgba(30, 35, 55, 0.6);
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 0.95em;
    }
    .connection-banner {
      background: rgba(0, 170, 255, 0.15);
      padding: 0.6rem;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
      font-weight: bold;
      color: #4caf50;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üëÅÔ∏è PANEL DEL VIGILANTE</h1>
    
    <!-- Formulario de login -->
    <div id="loginSection" class="instructions" style="text-align:center; padding:30px;">
      <h2>üîê Acceso restringido</h2>
      <p>Ingresa tus credenciales de Vigilante:</p>
      <input type="email" id="vigilanteEmail" placeholder="Email" style="width:100%; padding:10px; margin:10px 0; border-radius:4px; border:1px solid #4a3a2a; background:#2a3a5a; color:white;">
      <input type="password" id="vigilantePassword" placeholder="Contrase√±a" style="width:100%; padding:10px; margin:10px 0; border-radius:4px; border:1px solid #4a3a2a; background:#2a3a5a; color:white;">
      <button onclick="loginVigilante()" class="btn btn-watch" style="width:100%; margin-top:15px;">Ingresar</button>
      <div id="loginError" style="color:#f44336; margin-top:10px; display:none;"></div>
    </div>

    <!-- Panel principal (oculto inicialmente) -->
    <div id="mainPanel" style="display:none;">
      <div class="connection-banner" id="connection-status">
        üì° Conectando al servidor...
      </div>

      <div class="instructions">
        <strong>Instrucciones:</strong><br>
        ‚Ä¢ Los jugadores aparecen autom√°ticamente al aceptar su desaf√≠o.<br>
        ‚Ä¢ Toca <strong>üëÅÔ∏è OBSERVAR</strong> para conectar la videollamada.<br>
        ‚Ä¢ Usa los botones para guiar la misi√≥n en vivo.
      </div>

      <div id="players-list">
        <!-- Los jugadores se agregar√°n aqu√≠ din√°micamente -->
      </div>

      <div class="instructions" style="margin-top:30px;">
        <strong>Atajos de teclado (en videollamada):</strong><br>
        1 = ‚úÖ Validar desaf√≠o 1 &nbsp; | &nbsp; 2 = ‚ñ∂Ô∏è Desaf√≠o 2 &nbsp; | &nbsp; 3 = ‚ñ∂Ô∏è Desaf√≠o 3 &nbsp; | &nbsp; F = ‚ùå Fall√≥
      </div>
      
      <button onclick="logoutVigilante()" class="btn btn-danger" style="margin-top:20px; width:100%;">Cerrar sesi√≥n</button>
    </div>
  </div>

  <script>
    // ========== FIREBASE ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDvMo1LPD_FGk-Ahju8oN7WEn9w0B5bqUE",
      authDomain: "let-s-hunt.firebaseapp.com",
      databaseURL: "https://let-s-hunt-default-rtdb.firebaseio.com",
      projectId: "let-s-hunt",
      storageBucket: "let-s-hunt.firebasestorage.app",
      messagingSenderId: "787017812046",
      appId: "1:787017812046:web:da098b2361df4dda995b1f"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // === VARIABLES GLOBALES ===
    let ws;
    let currentUser = null;
    const players = new Map();

    // === AUTENTICACI√ìN ===
    async function loginVigilante() {
      const email = document.getElementById('vigilanteEmail').value.trim();
      const password = document.getElementById('vigilantePassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!email || !password) {
        errorDiv.textContent = "‚ö†Ô∏è Completa todos los campos";
        errorDiv.style.display = "block";
        return;
      }
      
      try {
        // Iniciar sesi√≥n
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Verificar rol en Realtime Database
        const userRef = db.ref(`usuarios/${user.uid}`);
        const snapshot = await userRef.once('value');
        
        if (!snapshot.exists()) {
          throw new Error("Usuario no autorizado");
        }
        
        const userData = snapshot.val();
        if (userData.rol !== 'vigilante' && userData.rol !== 'admin' || !userData.activo) {
          throw new Error("Acceso denegado - Rol no v√°lido");
        }
        
        // Guardar usuario actual
        currentUser = { uid: user.uid, email: user.email, rol: userData.rol };
        
        // Mostrar panel principal
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainPanel').style.display = 'block';
        document.getElementById('loginError').style.display = 'none';
        
        // Conectar WebSocket
        connectWebSocket();
        
      } catch (error) {
        console.error("Error de autenticaci√≥n:", error);
        errorDiv.textContent = "‚ùå " + (error.message || "Credenciales incorrectas");
        errorDiv.style.display = "block";
      }
    }

    function logoutVigilante() {
      auth.signOut().then(() => {
        currentUser = null;
        document.getElementById('mainPanel').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('vigilanteEmail').value = '';
        document.getElementById('vigilantePassword').value = '';
      });
    }

    // === CONEXI√ìN WEBSOCKET REAL ===
    function connectWebSocket() {
      const wsUrl = window.location.hostname === 'localhost' 
        ? 'ws://localhost:8080'
        : `wss://${window.location.hostname}/ws`;
      
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        document.getElementById('connection-status').innerHTML = 
          '<span style="color:#4caf50">‚úÖ Conectado al servidor</span>';
        console.log('‚úÖ Vigilante conectado al servidor');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        switch (data.type) {
          case 'players':
            players.clear();
            data.players.forEach(p => players.set(p.id, p));
            renderPlayers();
            break;
            
          case 'update':
            players.set(data.id, data);
            updatePlayerUI(data.id);
            break;
        }
      };

      ws.onerror = (e) => {
        document.getElementById('connection-status').innerHTML = 
          '<span style="color:#f44336">‚ùå Error de conexi√≥n</span>';
      };

      ws.onclose = () => {
        document.getElementById('connection-status').innerHTML = 
          '<span style="color:#ff9800">‚ö†Ô∏è Reconectando...</span>';
        setTimeout(connectWebSocket, 3000);
      };
    }

    // === RENDERIZAR JUGADORES ===
    function renderPlayers() {
      const container = document.getElementById('players-list');
      container.innerHTML = '';

      players.forEach((p, id) => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.id = `player-${id}`;
        card.innerHTML = `
          <div class="player-header">
            <div class="player-name">${p.id}</div>
            <div class="mission-id">misi√≥n ${p.mission || '1'}</div>
          </div>
          <div class="countdown" id="count-${id}">${formatTime(p.timeLeft || 900)}</div>
          <div class="video-container" id="video-${id}">
            <div class="video-placeholder">Toca üëÅÔ∏è OBSERVAR para conectar</div>
          </div>
          <div class="controls">
            <button class="btn btn-watch" onclick="connectVideo('${id}')">üëÅÔ∏è OBSERVAR</button>
            <button class="btn btn-success" onclick="validateStep('${id}', 1)">‚úÖ Validar 1</button>
            <button class="btn btn-success" onclick="validateStep('${id}', 2)">‚úÖ Validar 2</button>
            <button class="btn btn-success" onclick="validateStep('${id}', 3)">‚úÖ Validar 3</button>
            <button class="btn btn-danger" onclick="failMission('${id}')">‚ùå Fall√≥</button>
          </div>
          <div class="status" id="status-${id}">Esperando acci√≥n...</div>
        `;
        container.appendChild(card);
      });
    }

    function updatePlayerUI(id) {
      const p = players.get(id);
      if (p) {
        document.getElementById(`count-${id}`).textContent = formatTime(p.timeLeft || 0);
        document.getElementById(`status-${id}`).textContent = 
          `üìç Paso ${p.step || 1} ‚Ä¢ ${p.missions}M / ${p.challenges}D`;
      }
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // === ACCIONES DEL VIGILANTE ===
    function connectVideo(playerId) {
      const statusEl = document.getElementById(`status-${playerId}`);
      const videoEl = document.getElementById(`video-${playerId}`);
      
      statusEl.textContent = "üìû Llamando por WhatsApp...";
      
      // Registrar en Realtime Database
      db.ref('sesiones_vigilante').push({
        vigilanteId: currentUser.uid,
        jugadorId: playerId,
        mision: players.get(playerId)?.mission || 1,
        timestamp_inicio: Date.now(),
        estado: 'observando'
      });

      setTimeout(() => {
        videoEl.innerHTML = `
          <div style="height:100%;background:#000;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff">
            <div style="font-size:4em">üìπ</div>
            <div>Videollamada con ${playerId}</div>
            <div style="font-size:0.8em;color:#a89a85;margin-top:5px">
              Usa: 1, 2, 3 para validar ‚Ä¢ F para fallar
            </div>
          </div>
        `;
        videoEl.style.display = "block";
        statusEl.textContent = "‚úÖ En vivo ‚Äî observando";
        document.body.focus();
      }, 1500);
    }

    async function validateStep(playerId, step) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'command',
          target: playerId,
          action: 'validate',
          step: step
        }));
      }
      
      // Registrar validaci√≥n en Realtime Database
      try {
        await db.ref('validaciones_vigilante').push({
          vigilanteId: currentUser.uid,
          jugadorId: playerId,
          paso: step,
          mision: players.get(playerId)?.mission || 1,
          timestamp: Date.now(),
          resultado: 'exitoso'
        });
      } catch (error) {
        console.error("Error al registrar validaci√≥n:", error);
      }
      
      const statusEl = document.getElementById(`status-${playerId}`);
      statusEl.textContent = `‚úÖ Desaf√≠o ${step} validado`;
      console.log(`[Vigilante] Validado paso ${step} para ${playerId}`);
    }

    async function failMission(playerId) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'command',
          target: playerId,
          action: 'fail'
        }));
      }
      
      // Registrar fallo en Realtime Database
      try {
        await db.ref('fallos_vigilante').push({
          vigilanteId: currentUser.uid,
          jugadorId: playerId,
          mision: players.get(playerId)?.mission || 1,
          timestamp: Date.now(),
          razon: 'manual'
        });
      } catch (error) {
        console.error("Error al registrar fallo:", error);
      }
      
      const statusEl = document.getElementById(`status-${playerId}`);
      statusEl.textContent = "‚ùå Misi√≥n anulada";
      document.getElementById(`count-${playerId}`).style.color = "#f44336";
      console.log(`[Vigilante] Fall√≥ misi√≥n de ${playerId}`);
    }

    // === ATAJOS DE TECLADO ===
    document.addEventListener('keydown', (e) => {
      const activeVideo = document.querySelector('.video-container[style*="display: block"]');
      if (!activeVideo) return;
      
      const playerId = activeVideo.id.replace('video-', '');
      
      switch(e.key) {
        case '1': validateStep(playerId, 1); break;
        case '2': validateStep(playerId, 2); break;
        case '3': validateStep(playerId, 3); break;
        case 'f':
        case 'F': failMission(playerId); break;
      }
    });

    // === SESI√ìN PERSISTENTE ===
    auth.onAuthStateChanged((user) => {
      if (user) {
        const userRef = db.ref(`usuarios/${user.uid}`);
        userRef.once('value').then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            if ((userData.rol === 'vigilante' || userData.rol === 'admin') && userData.activo) {
              currentUser = { uid: user.uid, email: user.email, rol: userData.rol };
              document.getElementById('loginSection').style.display = 'none';
              document.getElementById('mainPanel').style.display = 'block';
              connectWebSocket();
            }
          }
        });
      }
    });

    // === INICIAR ===
    document.addEventListener('DOMContentLoaded', () => {
      // Simular datos iniciales si no hay conexi√≥n
      setTimeout(() => {
        if (players.size === 0 && !currentUser) {
          players.set('hunter_0001', { id: 'hunter_0001', mission: 1, step: 1, timeLeft: 842, missions: 0, challenges: 0 });
          players.set('hunter_0109', { id: 'hunter_0109', mission: 2, step: 1, timeLeft: 658, missions: 1, challenges: 3 });
          renderPlayers();
        }
      }, 2000);
    });
  </script>
</body>
</html>